<html>
    <html style="background-color:#B0B0B0"><head>
        <title>File to URI - Zlib compression</title>
        <meta name="description" content="">
        <meta name="author" content="Freddy Vandriessche">
        <meta charset="utf-8"> 
        <link rel="stylesheet"        href="../res/COM_MAIN.css">
        <script type="text/javascript" src="../res/COM_MAIN.js"></script>
        <script type="text/javascript" src="TOOLS_Header.js"></script>
        <script type="text/javascript" src="../res/pako.min.js"></script>
      </head>
      

  <script defer type="text/javascript">

    var CONF_version="1.1.1";
    var CONF_builddate="20240114-190000";

    var filename = "";

    function init_gui(_o)
    { 
        document.getElementById('slider_title').outerHTML = _TITLE();       
    }

    function load_file(file_obj)
    {
        var json_txt = oCOM.trim(document.getElementById("JSON").value);
        var json_txt = json_txt.replace(/(\r\n|\n|\r)/gm,"");
        var json_txt = json_txt.replace(/(\\)/gm,'\\\\');

        if(json_txt.slice(-1)==",") json_txt = json_txt.slice(0,-1);
        json_txt = "["+json_txt+"]";
        console.log(json_txt);

        try{ var j = JSON.parse(json_txt) }
        catch({ n,m }) { alert("parse error:"+n+" "+m); return null }
        
        var blob = window.URL.createObjectURL(file_obj)
        var oReq = new XMLHttpRequest();
        filename = file_obj.name

            var e = filename.split(".");
            ext = "."+e[e.length-1];
            ext = ext.toLowerCase(ext);

        oReq.open('GET', blob, true);
        oReq.responseType = 'arraybuffer';
        oReq.onload = function(e)
        {
            var isPerformanceSupported = (
                window.performance &&
                window.performance.now &&
                window.performance.timing &&
                window.performance.timing.navigationStart
            );

            var timeStampInMs = (
                isPerformanceSupported ?
                window.performance.now() +
                window.performance.timing.navigationStart :
                Date.now()
            );


            var arrayBuffer = oReq.response;
            if(arrayBuffer)
            {
                // COMPRESSION ALGORITHM
                var l1 = arrayBuffer.byteLength 
                var fym = new Uint8Array(arrayBuffer);
                const deflator = new pako.Deflate( { level: 9} );
                deflator.push(fym, true);
                var dump = deflator.result
                var l2 = dump.byteLength;
                try {  var l3 = oCOM.ArrayBufferTobase64(dump).length; }
                catch({ n, m }) { alert("ArrayBufferTobase64:"+n+" "+m) }

                // APPLY FILE EXTENTION MAPPING (according to JSON input)                
                var url = "";
                var uri_arg="d";
                var uri_hash = "";
                for(var i=0;i<j.length;i++)
                {
                    var r_str = j[i].regexp;
                    var r = new RegExp(r_str,"i");
                    var m = filename.match(r);
                    if(m!=null)
                    {
                        url = j[i].URL ? j[i].URL : "";
                        uri_arg = j[i].URI ? j[i].URI.replace(/=/,"") : "";
                        uri_hash = j[i].hash ? j[i].hash.replace(/#/,"") : "";
                    }
                }

                // CONSTRUCT URL AND URI
                var browsers = {"safari":80000,"firefox":65536,"chrome":2083,"edge":2083,"opera":1000000};
                var uri = oCOM.ArrayBufferTobase64(dump);
                var url = url+"?"+uri_arg+"="+uri+"#"+uri_hash;
                var s = "";
                for(var i in browsers) s += "<div style=float:left title=\"max. "+browsers[i]+" bytes\" ><img style='width:12px;margin-right:5px' src=../res/i_"+i+".png><br><img src=../res/"+(url.length<=browsers[i]?"i_ok.png":"i_nok.png")+" style=width:10px;padding-left:3px></div>"
                var link = "<div style='border:1px solid rgb(0,0,0,0)'><a target=_blank href="+url+">URL <small>(format:"+m+" bytes:"+url.length+" efficiency:"+(100-Math.round(100*url.length/l1))+"%)<small></a>"+s+"</div>";
 
                var el = document.getElementById("output");
                el.innerHTML += link;
            }
        }
        oReq.send();
    }
  </script>


<body class="slider_main" onload="init_gui();">

<div id="slider_title"></div>
<div class="slider_overlay">
    <div id="topmenu">
    <!--   BUTTON BAR -->
    <!--
    <ul id="minitabs">
        <li>

            <table class=no_margins style='display:inline-block;border:0px solid;vertical-align:top;'>
                <tr>
                    <td style="vertical-align:top;border:1px solid;width:200px">
           
                    </td>
                </tr>
            </table>
        </li>
    </ul>
    -->
    </div>
    <div id=main style="width:100%;height:100%;background: linear-gradient(180deg, rgba(220,220,220,1) 0%, rgba(251,251,251,1) 50%);">
    <table>
    <tr>
        <td><img style="margin:20px;width:256px;float:left;image-rendering:pixelated;" src="../res/zlib_icon.png"></td>
        <td rowspan="2" valign="top">
            <br>
            <button onclick="document.getElementById('getFile').click()">Load file</button>
            <input type='file' id="getFile" style="display:none" onchange="load_file(this.files[0]);">
            <br><br>
            <div id="output"></div>
        </td>
    </tr>
    <tr>
        <td>
            FILEext. - URI mapping<br>
            <textarea id=JSON style="font-family:'Courier';font-size:10px;float:left;width:500px;height:50px;resize:vertical;">
{"regexp":"\.(?:s)$"  ,"URI":"asm=" ,"URL":"../index.html","hash":"#tab2"},
{"regexp":"\.(?:dsk)$","URI":"dsk1=","URL":"../index.html","hash":"#tab1"},
{"regexp":"\.(?:sid)$","URI":"sid=" ,"URL":"SIDchipJS.html"},
{"regexp":"\.(?:fym)$","URI":"fym=" ,"URL":"MockingboardJS.html"},
            </textarea><br>
            <div id="dump" style="font-size:x-small;width:296px;height:120px;overflow-x:hidden;overflow-y:auto;">
            </div>
        </td>
    </tr>
    </table>
    </div>
</div>
  
</body>


</html>
