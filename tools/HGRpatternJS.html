<html style="background-color:#B0B0B0"><head>
  <title>APPLE II HGR PATTERN GENERATOR</title>
  <meta name="description" content="">
  <meta name="author" content="Freddy Vandriessche">
  <meta charset="utf-8">
  <style>
  html {height:100%;font-family:"Arial"}
  body {background-color:#808080;height:100%;margin:0px;padding:0px}
  .tcell10 {width:10px;height:10px;background-color:white;padding:0;border:1px solid white}
  .tcell10:hover { width:10px;height:10px;background-color:yellow;border:1px solid black }
  .tcell5 {width:5px;height:10px;background-color:lightgray;padding:0;border:0px solid white}
  .tcell5:hover { width:5px;height:10px;background-color:yellow;border:0px solid white}

  .leftpane {Â width:400px;  }
  /* vertical-align:top; margin:4px 0px 0px 0px; overflow-wrap:anywhere; */

  .tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: black;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 0;

  /* Position the tooltip */
  position: absolute;
  z-index: 1;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
}

#MyCanvas {
border:1px solid black;
}

.slider { display: inline-block; }
.smallbutton { width:15px;height:5px;font-size:12px;vertical-align:top;margin:13px 0px 0px 0px;padding:0px 0px 0px 0px;font-weight:800 }

  </style>
</head>

<script type="text/javascript" src="../res/EMU_apple2video.js"></script>
<script type="text/javascript" src="../res/EMU_apple2hw.js"></script>
<script type="text/javascript" src="../res/EMU_apple2io.js"></script>
<script type="text/javascript" src="../res/HGRpalette.js"></script>
<script type="text/javascript" src="../res/HGRpattern.js"></script>
<script type="text/javascript" src="../res/rhill-voronoi-core.js"></script>

<script>

// TODO CLICKING HIGH-BIT DOES NOT RENDER ALTERNATE COLORS !!!

/////////////////////////////////////////////////////////
// INITIALISE DATA

var CONF_version="";
var CONF_builddate="";  


var _D = 
{
     "blc":[10,10]       // pattern matrix
    ,"bls":[14,8]        // pattern sample size
    ,"opat":0            // pattern index offset
    ,"remExcl":true     // remove excluded patterns
    ,"leftpane":430      // size of left pane (grid)
    ,"bmapID":0          // location of editable grid
    ,"YVERTL":"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"
              +"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"
              +"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"
    ,"YVERTH":"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
              +"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
              +"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
}
var yref = new Array();
  for(var i=0;i<_D.YVERTL.length;i+=2)
    yref[i/2] = parseInt( _D.YVERTH.substring(i,i+2),16)*256
               +parseInt( _D.YVERTL.substring(i,i+2),16);


oPATTERN = new PATTERN();
var custom_bmap =  new Array(oPATTERN.bmapx).fill([false,0]).map(() => new Array(oPATTERN.bmapy).fill([false,0]));
var custom_fmla = ["",""];
var oPALETTE = new PALETTE();

/*
var styl = " style='padding:5px;border:1px solid;font-family:Courier New'"
document.write("<div"+styl+"><small>")
for(var idx=0;idx<(255*3);idx++)
{
  document.write("<table>");
  for(var y=0;y<10;y++)
  {
    document.write("<tr>");
    var s="";
    for(var x=0;x<10;x++)
    {
      var c = oPATTERN.calculate_alt(idx,x,y);
      var pix = c[1]?"background-color:black":"";
      var bck = (c[2]==128?"border-color:#FF0000":"");

      s+="<td class=tcell10 style=\""+pix+";padding:0;"+bck+"\"></td>"
    }
    document.write(s+"<tr>");
  }
  document.write("</table><br>");
}
document.write("</small></div>")
*/


/////////////////////////////////////////////////////////
// ONLOAD

function init_gui(_o)
{
  document.getElementById('slider_title').outerHTML = _TITLE();
  vidContext          = document.getElementById('applescreen').getContext("2d");
  apple2plus          = new Apple2Plus(vidContext);

  apple2plus.video.setCol(3,0,"#FF40FF");   // overload purple
  apple2plus.video.setCol(6,0,"#2F95FF");   // overload blue
  apple2plus.video.setCol(9,0,"#FFA040");   // overload orange
  apple2plus.video.setCol(12,0,"#A0FF20");  // overload green

  var a = oPATTERN.parse(), s = "", sep = " ; ";
  for(var i in a) s+= "<option value=\""+i+sep+a[i][0]+sep+a[i][1]+sep+"\">\n";
  document.getElementById("formulas").innerHTML = s;

  oPALETTE.insert_canvas({"id":"mainPalette","width":430,"height":150});
  update_criteria();
  generate_GRIDS();
  generate_HGR();
  oPALETTE.dot_size=6;
  oPALETTE.color_depth=24;
  oPALETTE.draw_rainbow();
  document.getElementById("param3").max = oPALETTE.hex_pal.length-1; // set slider range
  update_param();


  oPALETTE.clear_layer(1);
  // DRAW VORONOI 
  oVoronoi.init(oPALETTE.canvas[1].id);
  for(var i=0;i<oPALETTE.dec_near_col.length;i++)
    if(oPALETTE.dec_near_pos[i][0][0])
      oVoronoi.addSite(oPALETTE.dec_near_pos[i][0]);
  oVoronoi.compute();
  oVoronoi.render();

  oPALETTE.opat = _D.opat;
  oPALETTE.draw_colormatches();
}

/////////////////////////////////////////////////////////
// CALL FUNCTIONS

var vidContext, apple2plus;
function Apple2Plus(context)
{
  this.video = new Apple2Video(context);
  this.hw    = new Apple2Hw(this.video);
  // Switch on Apple II Hi-Res graphics
  this.video.reset();
  this.video.setGfx(true);
  this.video.setHires(true);
  this.video.redraw();
}

var hextab= ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F']; 
function getHexByte(v) { return hextab[v>>4]+hextab[v&0xf] }
//function HEX2RGB(hex) { var n=parseInt(hex.slice(1),16); return [(n>>16)&0xFF,(n>>8)&0xFF,n&0xFF] }
function RGB2HEX(dec) { return [getHexByte(dec[0]),getHexByte(dec[1]),getHexByte(dec[2])] }



function patPixel_HGR(x,y,patternID)
{
    // find address and bit location
    var adr = yref[y] + Math.floor(x/7);              // find address 
    var rbyt = apple2plus.hw.read(adr);               // read byte
    var wbyt = oPATTERN.pixel(x,y,patternID,rbyt)
    apple2plus.hw.write(adr,wbyt);                    // write byte 
}

function setPixel_HGR(x,y,h)
{
    // find address and bit location
    var adr = yref[y] + Math.floor(x/7);              // find address 
    var rbyt = apple2plus.hw.read(adr);
    var wbyt = rbyt | (1 << x%7) | (h?h:0);
    apple2plus.hw.write(adr,wbyt);                    // write byte 
}

function clearPixel_HGR(x,y,h)
{
    // find address and bit location
    var adr = yref[y] + Math.floor(x/7);              // find address 
    var rbyt = apple2plus.hw.read(adr);
    var wbyt = rbyt & ~(1 << x%7) & 127 | (h?h:0);              // AND current bit with pixel bit
    apple2plus.hw.write(adr,wbyt);                    // write byte 
}

function getPixel_HGR(x,y)
{
    // find address and bit location
    var adr = yref[y] + Math.floor(x/7);              // find address 
    var rbyt = apple2plus.hw.read(adr);
    var bit = (rbyt >> (x%7)) & 1 == 1;
    bit = x<0 || x>279 ? 0 : bit;                     
    var b7  = rbyt & 128;
    return [ bit,b7 ]
}

function wipe_HGR(byte)
{
    // find address and bit location
    //var adr = yref[y] + Math.floor(x/7);              // find address 
    //var wbyt = apple2plus.hw.read(adr) | 1 << x%7;    // OR current bit with pixel bit
    for(var adr=8192;adr<16384;adr++)
    apple2plus.hw.write(adr,byte);                      // write byte 
}

function PRINTByte(by)
{
  var sa = ("0000000"+by.toString(2)).slice(-8).split("");
  //sa = sa.reverse();
  var styl = " style='padding:5px;border:1px solid;font-family:Arial'"
  return "<table style='border-collapse: collapse;'><tr><td"+styl+">"+sa.join("</td><td"+styl+">")+"</td></tr></table>"
}

function Cpix(t,x,y,z)
{ 
  if(z==0)
    custom_bmap[x][y] = [ custom_bmap[x][y][0]?false:true, custom_bmap[x][y][1]];
  else
  {
     for(var i=x;i>(x-7);i--)
        custom_bmap[i][y] = [ custom_bmap[i][y][0], custom_bmap[i][y][1]==0?128:0];
  }
  var o=t.parentNode.style; o.backgroundColor=o.backgroundColor?"":"green";
}

// SHOW BITMAP TABLES (LEFT PANE)
function generate_GRIDS()
{
  var im = "data:image/gif;base64,R0lGODlhAQABAPAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
  //var im = "../res/pixT.gif";
  var dot = ["<img src=\""+im+"\" style=\"width:9px;height:9px\" onclick=Cpix(this)>"
            ,"<img src=\""+im+"\" style=\"width:5px;height:9px\" onclick=Cpix(this)>"]
  // TODO: MODIFIERS - preset pattern -  load/save pattern)

  // PARSE PATTERN FUNCTION - CASE BY CASE
  formula_ref = oPATTERN.parse(); //parse_FORMULA()

  var DOUBL = {}
  s= "<big><font color=white>BITMAP GRIDS<font></big><br><br>";
  //var pmax = _D.blc[1]*_D.blc[0];
  var pmax = oPATTERN.pmax;
  for(var p=0;p<pmax;p++)
  {
    var c = oPATTERN.color(p+_D.opat,apple2plus.video.getPixelColor);    // calculate average color of patternID, by borrowing getPixelColor function from emulator
    var cs = "#"+RGB2HEX(c).join("");

    if(DOUBL[cs] && _D.remExcl) continue; else DOUBL[cs] = true;  // PATTERN SKIP CRITERIA

    var cs2 = [Math.round(100*c[0]/255),Math.round(100*c[1]/255),Math.round(100*c[2]/255)];
    var tc = cs2[0]>90 && cs2[1]>90 && cs2[2]>90 ? "black":"white";

    var cc = check_criteria(p);
    if(_D.remExcl==false || cc[0]!="EXCL" && cc[0]!="DOUBL")
      oPALETTE.hex_pal[p] = cs;

    s+= "<div style='width:430px;background-color:"+cs+";color:"+tc+";vertical-align:top; margin:4px 0px 0px 0px; overflow-wrap:anywhere;'><big>"+(p+_D.opat)+"</big> "
       +"<small>"+cs+" ("+cs2.join("% ")+"%) sat:"+oPALETTE.colorSaturation(c)+"</small>"
    s+= formula_ref[p+_D.opat]?("<br>"+formula_ref[p+_D.opat]):"";
    s+="</div>"
    s+= "<table style='margin:0;padding:0;border:1px solid "+(p==_D.bmapID?"red":"black")+";'>";
    for(var y=0;y<oPATTERN.bmapy;y++)
    {
      s+="<tr>";
      for(var x=0;x<oPATTERN.bmapx;x++) s+= gen_cell(p+_D.opat,x,y,p==_D.bmapID?dot:["",""]);
      s+="</tr>";
    }
    s+="</table><br>";
  }  
  document.getElementById("debug").innerHTML = s;



  // TODO >> fish color array !!! (oPATTERN.color(p))
  //draw();  // DOES NOT LOAD ???
}

function generate_REPORT()
{
  // PARSE PATTERN FUNCTION - CASE BY CASE
  formula_ref = oPATTERN.parse(); //parse_FORMULA()

  s= "var d = {\r\n";
  var pmax = _D.blc[1]*_D.blc[0];
  for(var p=0;p<pmax;p++)   // this is the display matrix size
  {
    if(oPATTERN.calculate(p,0,0)[0]!=null)
    {
      var c = oPATTERN.color(p,apple2plus.video.getPixelColor);    // calculate average color of patternID, by borrowing getPixelColor function from emulator
      var cs = "#"+RGB2HEX(c).join("");
      oPALETTE.hex_pal[p] = cs;
      cs="\"col\":\""+cs+"\""
       +",\"sat\":"+oPALETTE.colorSaturation(c)
       +",\"cmp\":["
      for(var o in oPATTERN.colorIDX)
        cs+="\""+o+"\","
      cs = cs.slice(0,-1);
      cs += "]"

      s += p+":{"+cs+"}\r\n"
    }
  }
  s+="}"
  copyTextToClipboard(s);
}

function gen_cell(patternID,x,y,img)
{
  var c = oPATTERN.calculate(patternID,x,y);
  var bi = isNaN(patternID); 

  // TODO DEBUG color definitions
  if(patternID == _D.bmapID)
  {
    var left = x<=0 ? false : custom_bmap[x-1][y][0];
    var me = custom_bmap[x][y][0];
    var right = x>=(oPATTERN.bmapx-1) ? false : custom_bmap[x+1][y][0];
    var b7 = custom_bmap[x][y][1]==128?1:0;

    //var col = getPixelColor_HGR(x, y, left, me, right, b7)
    //var alt = "<span class=tooltiptext style=color:"+col+";font-size:8px>"+col+"("+[left,me,right,b7].join(",")+")</span>";
    var css = "tooltip "
    var alt = "";
  }
  else { alt = ""; css = ""}

  var pix = c[1]?"background-color:black":"";
  var bck = (c[2]==128?"border-color:#FFE9D0":"");
  var s= "<td class='"+css+"tcell10' alt=\""+alt+"\" style=\""+pix+";padding:0;"+bck+"\">"+img[0].replace(/this/g,"this,"+x+","+y+",0")+alt+"</td>"
  if((x+1)%7==0)
    s+= "<td class=tcell5 style=\""+(c[2]==128?"background-color:black":"")+"\">"+img[1].replace(/this/g,"this,"+x+","+y+",1")+"</td>"
  return s;
}

// TODO make oPATTERN object from function
function update_criteria()
{
  oPATTERN.criteria_desc = {
    "DOUBL":"Redundant, same color"
  ,"SAT":"Color composition with low saturation"
  ,"VPAT":"Heavy vertical lines"
  ,"PROX":"Redundant, too close to an optimal pattern"}
  oPATTERN.criteria = {"EXCL":{9:"PROX(3)",13:"PROX(7)",14:"PROX(11)",17:"VPAT",18:"SAT",19:"VPAT",20:"VPAT",24:"SAT",25:"PRX(22)",29:"PROX(23)",33:"SAT",34:"VPAT",35:"PROX(41)",36:"SAT",38:"PROX(41)",44:"PROX(41)",46:"PROX(43)",50:"PROX(41)",51:"VPAT",54:"VPAT",55:"VPAT",56:"PROX(41)",57:"VPAT",59:"VPAT",63:"VPAT",66:"SAT",72:"SAT",73:"PROX(22)",77:"PROX(23)",89:"PROX(53)",91:"PROX",93:"PROX",94:"PROX",98:"PROX(41)",99:"VPAT"
                      ,102:"VPAT",103:"VPAT",104:"PROX(41)",107:"PROX(62)",108:"VPAT",110:"VPAT",111:"VPAT",115:"VPAT",118:"VPAT",119:"VPAT",124:"PROX(61)",126:"PROX",129:"SAT",132:"SAT",131:"PROX(41)",134:"PROX(41)",136:"VPAT",140:"PROX(41)",142:"PROX(43)",144:"PROX(3)",145:"PROX(22)",147:"VPAT",148:"PROX(22)",149:"PROXY(53)",153:"VPAT",154:"PROX(58)",155:"VPAT",156:"VPAT",157:"VPAT",158:"PROX(62)",159:"VPAT",169:"PROX(58)",173:"PROX(122)",174:"PROX",179:"VPAT",182:"PROX(62)",185:"VPAT",186:"PROX",187:"VPAT",188:"PROX(62)",189:"PROX",194:"PROX(41)",198:"VPAT",199:"PROX(61)"
                      ,200:"PROX(41)",201:"VPAT",203:"PROX(62)",204:"VPAT",206:"VPAT",207:"VPAT",208:"PROX(7)",209:"PROX(23)",213:"PROX(87)",217:"VPAT",218:"PROX(122)",219:"PROX(123)",221:"VPAT",222:"SAT",223:"PROX(127)",224:"PROX(11)",226:"PROX(43)",229:"PROX(181)",231:"SAT",232:"PROX(43)",233:"PROX(182)",234:"PROX",236:"VPAT",237:"PROX(123)",238:"VPAT",239:"PROX(191)",243:"VPAT",246:"VPAT",249:"VPAT",252:"VPAT",253:"PROX(127)",254:"PROX(191)",265:"PROX(3)",269:"PROX(263)",270:"PROX(267)",273:"VPAT",274:"VPAT",280:"VPAT",281:"PROX(25)",285:"PROX(279)",290:"VPAT",291:"PROX(41)",293:"PROX(35)",294:"PROX(41)",295:"PROX(301)",297:"PROX(41)"
                      ,300:"PROX(41)",302:"PROX(299)",305:"PROX(404)",306:"PROX(658)",307:"VPAT",311:"VPAT",313:"VPAT",315:"VPAT",319:"VPAT",329:"PROX(22)",333:"PROX(279)",343:"PROX(349)",345:"PROXY(53)",350:"PROX(347)",351:"PROX(105)",355:"VPAT",358:"VPAT",359:"VPAT",361:"PROX(105)",363:"VPAT",367:"VPAT",371:"VPAT",374:"VPAT",375:"VPAT",377:"PROX(61)",379:"VPAT",380:"PROX(61)",387:"PROX(41)",390:"PROX(41)",392:"VPAT",393:"PROX(35)",396:"PROX(41)",398:"PROX(299)"
                      ,400:"PROX(3)",401:"PROX(305)",402:"PROX(306)",403:"VPAT",405:"PROX(309)",404:"PROX(308)",406:"PROX(105)",407:"PROX(317)",408:"PROX(306)",409:"VPAT",410:"PROX(314)",411:"VPAT",413:"VPAT",414:"PROX(318)",415:"VPAT",425:"PROX(58)",429:"PROX(423)",430:"PROX(427)",435:"VPAT",438:"PROX(62)",441:"VPAT",443:"VPAT",444:"PROX(62)",445:"PROX(439)",454:"VPAT",455:"PROX(317)",457:"VPAT",459:"PROX(318)",460:"VPAT",461:"VPAT",462:"VPAT",463:"VPAT",464:"PROX(7)",465:"PROX(279)",468:"PROX(279)",469:"PROX(373)",473:"VPAT",474:"PROX(378)",475:"PROX(382)",477:"VPAT",478:"PROX(478)",479:"PROX(127)",480:"PROX(11)",481:"PROX(391)",485:"PROX(437)",486:"VPAT",487:"PROX(439)",489:"PROX(62)",490:"PROX(442)",491:"PROX(446)",492:"VPAT",493:"PROX(439)",494:"PROX(491)",495:"PROX(191)",499:"VPAT"
                      ,502:"VPAT",505:"VPAT",508:"VPAT",509:"PROX(503)",510:"PROX(507)",521:"PROX(3)",525:"PROX(263)",526:"PROX(267)",529:"VPAT",530:"SAT",536:"SAT",537:"PROX(308)",541:"PROX(535)",542:"PROX(539)",545:"SAT",546:"VPAT",547:"VPAT",548:"SAT",553:"PROX(402)",557:"PROX(542)",558:"PROX(555)",563:"VPAT",566:"VPAT",567:"VPAT",569:"VPAT",571:"VPAT",575:"VPAT",578:"SAT",584:"SAT",585:"PROX(308)",589:"PROX(535)",590:"PROX(539)"
                      ,601:"PROX(309)",605:"PROX(599)",606:"PROX(603)",611:"VPAT",614:"VPAT",615:"VPAT",617:"PROX(105)",619:"PROX(318)",620:"VPAT",622:"VPAT",623:"VPAT",627:"VPAT",630:"VPAT",631:"VPAT",636:"PROX(317)",638:"PROX(635)",641:"SAT",644:"SAT",648:"SAT",649:"PROX(306)",653:"PROX(539)",654:"PROX(555)",656:"PROX(3)",657:"PROX(308)",658:"PROX(312)",659:"VPAT",660:"PROX(308)",661:"PROX(309)",662:"PROX(105)",664:"PROX(312)",665:"VPAT",666:"PROX(314)",667:"VPAT",668:"VPAT",669:"VPAT",670:"PROX(318)",671:"VPAT",681:"PROX(314)",685:"PROX(634)",686:"PROX(683)",691:"VPAT",694:"PROX(318)",697:"VPAT",699:"VPAT"
                      ,700:"PROX(318)",701:"PROX(635)",710:"VPAT",711:"PROX(317)",713:"VPAT",715:"PROX(318)",716:"VPAT",717:"VPAT",718:"VPAT",719:"VPAT",720:"PROX(263)",721:"PROX(535)",724:"PROX(535)",725:"PROX(599)",729:"VPAT",730:"PROX(634)",731:"PROX(635)",732:"VPAT",733:"VPAT",734:"PROX(635)",735:"PROX(503)",736:"PROX(267)",737:"PROX(653)",738:"PROX(555)",740:"PROX(653)",741:"PROX(603)",742:"VPAT",743:"PROX(701)",744:"PROX(555)",745:"PROX(459)",746:"PROX(683)",748:"VPAT",749:"PROX(701)",750:"VPAT",751:"PROX(507)",755:"VPAT",758:"VPAT",761:"VPAT",764:"VPAT",765:"PROX(503)",766:"PROX(507)"
                    }}  // TODO ADD MORE EXCLUSIONS
  // VPAT: outspoken vertical pattern
  //var excl = []
  //for(var i=0;i<excl.length;i++)
  //  oPATTERN.criteria.EXCL[excl[i]] += ",BAD";

  // INVENTORIZE DOUBLES (PATTERNS WITH SAME COLOR)
  var doubles = {};
  for(var p=0;p<oPATTERN.pmax;p++)
  {
    var c = oPATTERN.color(p,apple2plus.video.getPixelColor);    // calculate average color of patternID, by borrowing getPixelColor function from emulator
    var cs = "#"+RGB2HEX(c).join("");
    //if(typeof(oPATTERN.criteria.DOUBL[cs])!="number" && !oPATTERN.criteria.EXCL[p]) oPATTERN.criteria.DOUBL[cs] = p;

    if(typeof(doubles[cs])!="number" && !oPATTERN.criteria.EXCL[p]) doubles[cs] = p;
    else oPATTERN.criteria.EXCL[p] = typeof(oPATTERN.criteria.EXCL[p])!="string"?("DOUBL("+doubles[cs]+")"):(oPATTERN.criteria.EXCL[p]+",DOUBL("+doubles[cs]+")");

    //if(oPATTERN.criteria.EXCL[p] && oPATTERN.criteria.EXCL[p].indexOf("DOUBL")<0) oPATTERN.criteria.EXCL[p] += " DOUBL"
    //if(typeof(oPATTERN.criteria.EXCL[p])!="string" ) oPATTERN.criteria.EXCL[p] = "EXCL";
  }

  // TODO DIRECT EXCLUSION
  //for(var i in oPATTERN.criteria.DOUBL)
  //  document.write("DOUBL["+i+"]="+oPATTERN.criteria.DOUBL[i]+"<br>")

  //for(var i in oPATTERN.criteria.EXCL)
  //  document.write("EXCL["+i+"]="+oPATTERN.criteria.EXCL[i]+"<br>")
}

function check_criteria(patternID)
{
  var c = oPATTERN.color(patternID,apple2plus.video.getPixelColor);    // calculate average color of patternID, by borrowing getPixelColor function from emulator
    var cs = "#"+RGB2HEX(c).join("");
    if(oPATTERN.criteria.EXCL[patternID])
    {
      if(oPATTERN.criteria.EXCL[patternID].substring(0,5)=="DOUBL") return oPATTERN.criteria.EXCL[patternID].split("(")
      else return ["EXCL"]
    }
    //if(oPATTERN.criteria.EXCL[patternID]) return "EXCL";
    //if(oPATTERN.criteria.DOUBL[cs]!=patternID) return  "DOUBL";
    return [0];
}

function generate_HGR()
{ 
    wipe_HGR(0);
    var spc = [11,11];
    var ofs = [-5,-4]
    //var DOUBL = {};

  //var pmax = _D.blc[1]*_D.blc[0];
  var pmax = oPATTERN.pmax;
  //var bDouble = false;

  for(var p=_D.opat,dx=0,dy=0;p<pmax;p++)
  {

    if(_D.remExcl)
    {
      for(;p<pmax;p++)
      {
        var cc = check_criteria(p);
        var c = oPATTERN.color(p,apple2plus.video.getPixelColor);    // calculate average color of patternID, by borrowing getPixelColor function from emulator
        var cs = "#"+RGB2HEX(c).join("");
        if(cc[0]==0) break;
        //if(typeof(DOUBL[cs])=="undefined") { pid=p; break; }        // PATTERN SKIP CRITERIA
      }
      //if(p==pmax) break;
    }

    var c = oPATTERN.color(p,apple2plus.video.getPixelColor);    // calculate average color of patternID, by borrowing getPixelColor function from emulator
    var cs = "#"+RGB2HEX(c).join("");

    // DRAW LINE SQUARE
    for(var x=-3;x<_D.bls[0]+3;x++)
    {
      //setPixel_HGR(ofs[0]+x+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]-4+spc[1]+dy*(_D.bls[1]+spc[1]));
      //setPixel_HGR(ofs[0]+x+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]-3+spc[1]+dy*(_D.bls[1]+spc[1]));
      setPixel_HGR(ofs[0]+x+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]+_D.bls[1]+2+spc[1]+dy*(_D.bls[1]+spc[1]));
      setPixel_HGR(ofs[0]+x+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]+_D.bls[1]+3+spc[1]+dy*(_D.bls[1]+spc[1]));
    }
    for(var y=-3;y<_D.bls[1]+3;y++)
    {
      setPixel_HGR(ofs[0]-4+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]+y+spc[1]+dy*(_D.bls[1]+spc[1]));
      setPixel_HGR(ofs[0]-3+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]+y+spc[1]+dy*(_D.bls[1]+spc[1]));
      setPixel_HGR(ofs[0]+_D.bls[0]+2+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]+y+spc[1]+dy*(_D.bls[1]+spc[1]));
      setPixel_HGR(ofs[0]+_D.bls[0]+3+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]+y+spc[1]+dy*(_D.bls[1]+spc[1]));
    }          

    // DRAW PATTERN SQUARE
    for(var y=0;y<_D.bls[1];y++)
        for(var x=0;x<_D.bls[0];x++)
            patPixel_HGR(ofs[0]+x+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]+y+spc[1]+dy*(_D.bls[1]+spc[1]),p);

    // DRAW NUMBERS
    //clearPixel_HGR(-3+spc[0]+dx*(_D.bls[0]+spc[0]),ofs[1]+0+spc[1]+dy*(_D.bls[1]+spc[1]),"");
    var ddx = ofs[0]+spc[0]+dx*(_D.bls[0]+spc[0])-5;
    var ddy = ofs[1]+spc[1]+dy*(_D.bls[1]+spc[1])-5;
    clearPixel_HGR(ddx+1,ddy+4);
    clearPixel_HGR(ddx+2,ddy+4);
    clearPixel_HGR(ddx+1+_D.bls[0]+6,ddy+2);
    clearPixel_HGR(ddx+1+_D.bls[0]+7,ddy+2);
    clearPixel_HGR(ddx+1+_D.bls[0]+6,ddy+3);
    clearPixel_HGR(ddx+1+_D.bls[0]+7,ddy+3);

    var cc = check_criteria(p);

    if(cc[0]=="EXCL")   // EXCLUDED
    {
      draw_number(12,[ddx,ddy-1]);
      ddx+=6;
      var digits = p.toString(10);
      for(var c=0;c<digits.length;c++)
        draw_number(Number(digits[c]),[ddx+c*6,ddy-1])      
    }
    else if(cc[0]=="DOUBL")   // DOUBLE
    {
      //document.write("hoi");
      draw_number(11,[ddx,ddy-1]);
      ddx+=6;
      //var digits = oPATTERN.criteria.DOUBL[cs].toString(10);
      var digits = cc[1].split(")")[0].toString(10);
      for(var c=0;c<digits.length;c++)
        draw_number(Number(digits[c]),[ddx+c*6,ddy-1])
    }
    else
    {
      // NORMAL
      var digits = p.toString(10);
      for(var c=0;c<digits.length;c++)
        draw_number(Number(digits[c]),[ddx+c*6,ddy-1])
    }
    // detect 2x2 patterns
    if(oPATTERN.is_2x2(p)) draw_number(10,[ddx+c*6,ddy-1]);

    //if(!bDouble)
    //  DOUBL[cs] = p;  // skip patterns that generate identical color

    if(dx==_D.blc[0]-1) dx=0; else { dx++; continue; }
    if(dy==_D.blc[1]-1) break; else dy++;
  }
}

function draw_number(num,pos)
{
  var numberfont = 
  [
   ["01110","00110","01110","11110","00111","11111","01111","11111","01110","01110","11011","00000","10001"]
  ,["11011","01110","11011","00011","01111","11000","11000","00011","11011","11011","01110","00101","00100"]
  ,["11011","00110","00110","01110","11011","11110","11110","00110","01110","01111","11011","10100","00100"]
  ,["11011","00110","01100","00011","11111","00011","11011","01100","11011","00110","00000","00101","00100"]
  ,["01110","01111","11111","11110","00011","11110","01110","11000","01110","01100","00000","00000","10001"]
  ]

  // DRAW NUMBER
  for(var x=0;x<5;x++)
    for(var y=0;y<5;y++)
    {
        if(numberfont[y][num].charAt(x)=="1") setPixel_HGR(x+pos[0],y+pos[1],128);
        else clearPixel_HGR(x+pos[0],y+pos[1],128);
        clearPixel_HGR(x+1+pos[0],y+pos[1],128);
        clearPixel_HGR(x+2+pos[0],y+pos[1],128);
    }
}

function fallbackCopyTextToClipboard(text) {
  var textArea = document.createElement("textarea");
  textArea.value = text;
  
  // Avoid scrolling to bottom
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.position = "fixed";

  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    var successful = document.execCommand('copy');
    var msg = successful ? 'successful' : 'unsuccessful';
    console.log('Fallback: Copying text command was ' + msg);
  } catch (err) {
    console.error('Fallback: Oops, unable to copy', err);
  }

  document.body.removeChild(textArea);
}

function copyTextToClipboard(text) {
  if (!navigator.clipboard) {
    fallbackCopyTextToClipboard(text);
    return;
  }
  navigator.clipboard.writeText(text).then(function() {
    console.log('Async: Copying to clipboard was successful!');
  }, function(err) {
    console.error('Async: Could not copy text: ', err);
  });
}

function update_param()
{
    if(document.getElementById("param3"))
    {
        var dot_idx   = Number(document.getElementById("param3").value);
        oPALETTE.limit_dots = {}
        if(dot_idx>=0) oPALETTE.limit_dots[dot_idx] = true;
        else dot_idx = "";
        document.getElementById("disp_param3").innerHTML 
        ="<font color=white>dot select "+(dot_idx+_D.opat)+"</font>"
    }

    if(document.getElementById('param4'))
    {
        var num = Number(document.getElementById('param4').value);
        if(num<0) num = 0;
        document.getElementById('param4').value = num;
        _D.opat = num * ( _D.blc[0]*_D.blc[1] )
    }
}


var oVoronoi = 
{
  voronoi: new Voronoi(),
  sites: [],
  bbox: {xl:0,xr:800,yt:0,yb:600},

  init: function(canvasID) {  this.canvas = document.getElementById(canvasID) },

  addSite: function(coord) {
      // create vertices
          this.sites.push({
              x: coord[0],
              y: coord[1]
              });
      },

  compute: function(xc,yc) {
      this.voronoi.recycle(this.diagram);
      this.diagram = this.voronoi.compute(this.sites, this.bbox);
    },

  render: function() {
      var ctx = this.canvas.getContext('2d');

      // voronoi
      if (!this.diagram) {return;}
      // edges

      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#FFF';
      var edges = this.diagram.edges,
          iEdge = edges.length,
          edge, v;
      while (iEdge--) {
          edge = edges[iEdge];
          v = edge.va;
          ctx.moveTo(v.x,v.y);
          v = edge.vb;
          ctx.lineTo(v.x,v.y);
          }
      ctx.stroke();
      }
}

/////////////////////////////////////////////////////////
// GUI TEMPLATE

var _T = function _T(idx,mod) {
this.t = {get _language(){ return "NL" }
,"title":document.title
,"menu_convert":""
,"menu_info":"Info/Contact"
,"intro":""
,"version":(CONF_version?("Version "+CONF_version):"")
,"built":(CONF_builddate?("Built "+CONF_builddate):"")
,get _(){return this}
}
if(idx.length>0 && typeof(this.t[idx])=="undefined") { alert(idx); return "<font color=red>"+idx+"</font>" }
switch(mod) {
  case "cap": return this.t[idx].charAt(0).toUpperCase()+this.t[idx].substring(1,this.t[idx].length);
  case "inv": { var j = {}; for(var i in t) { j[ t[i] ] = i }; return j } // inverse associative
  default: return this.t[idx];
}
}
function _D(idx) { if(typeof(_T(idx)=="string")) document.write(_T(idx)) }
function _TITLE() {
var hight_pct = 6;
var css = "#texturespace {background: #f7f7f7 url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAEEAYAAAD5YUI9AAAACXBIWXMAAA4mAAAOJgGi7yX8AAAARElEQVQIHWPYyrxTed9eg3UQWkQHQgtaQGg5JgaohAdUoglC8z+A0mFQBYIpUIEXULoOQgvIQRXIBUElMqASShBaWQwApNg4NPAzQGwAAAAASUVORK5CYII=') repeat center top;font: 62.5%/1 sans-serif;height: 100%;width: 100%;}"
+"#carvetext {color: transparent;background: #f7f7f7;font: 62.5%/1 sans-serif;stroke: 2px rgba(0,0,0,0.2);background-color: rgba(140,140,140,1);-webkit-background-clip: text;text-shadow: rgba(255,255,255,0.5) 0 5px 6px, rgba(255,255,255,0.2) 1px 3px 3px;transition: text-shadow .1s ease-out, background-color .2s ease-out;}"
+"#carvetext:hover {color: transparent;background-color: rgba(82,96,117,0.5);-webkit-background-clip: text;text-shadow: rgba(255,255,255,0.5) 0 5px 6px;}"
+"#carvetext:focus {outline: none;}.slider_main {position: relative;height: 100%;}"
+".slider_overlay {position: absolute;bottom: 0;left: 0;right: 0;background-color: #A0A0A0;overflow: hidden;width: 100%;height: 85%;transition: .5s ease;}"
//+".slider_main:hover "
+".slider_overlay {height: 100%;}"
+"#topmenu{width:100%;background-color:#f0f0f0}"
+"ul#minitabs{list-style:none;margin:0;padding:3px 0 0 0;border-left:1px solid #ccc;border-right:1px solid #ccc;border-top:1px solid #ccc;border-bottom:1px solid #ccc;font-weight:700;text-align:left;white-space:nowrap}ul#minitabs li{display:inline;margin:0 3px}ul#minitabs a{text-decoration:none;color:#999}ul#minitabs a#current{border-color:#f60;color:#06f}ul#minitabs a:hover{border-color:#f60;color:#666}"

return "<style>"+css+".slider_overlay{height: "+(100-hight_pct)+"%}</style>"
+"<div id=texturespace style='height:100%;width:100%'><center><div id='carvetext'>"
+"<div style='font-size:5em'>"+(typeof(_T("title"))=="string"?_T("title"):"")+"</div>"
+"<div style='font-size:1em'>"+(typeof(_T("version"))=="string"?_T("version"):"")
+" &nbsp; "+(typeof(_T("built"))=="string"?_T("built"):"")+"</div>"
+"</div></center></div>"
}

function load_bitmap()
{
  var sep = " ; "
  var sel = document.getElementById("FSL").value.split(sep);

  custom_fmla[0] = sel[1];
  custom_fmla[1] = sel[2];
  //var patternID = _D.bmapID; 

  // FILL custom_bmap using custom_fmla
  for(var y=0;y<oPATTERN.bmapy;y++)
  {
    for(var x=0;x<oPATTERN.bmapx;x++) 
      custom_bmap[x][y] = [eval(custom_fmla[0]),eval(custom_fmla[1])];
  }

  generate_GRIDS();
}
</script>

 <body class="slider_main" onload="init_gui()">
<div id="slider_title"></div>
 <div class="slider_overlay">
    <div id="topmenu">
      <ul id="minitabs">
        <li>
          <input autofocus style=width:430px list="formulas" name="formula-selector" id="FSL" value="select a pattern here" onclick=this.value='' />
          <datalist id="formulas" ></datalist>
        </li>
        <li><input type=button value="load" onclick="load_bitmap();document.getElementById('FSL').focus()" style='vertical-align:top; margin:4px 0px 0px 0px'></li>
        <li><img src='data:image/gif;base64,R0lGODlhGAAYAPAAAF3/AAAAACH5BAEAAAAALAAAAAAYABgAAAJPhG+hiu0Y4JsnSvqsBRvXtHXVQmpM4ogN+V1T2aJcSZ9cW+c4mNOf2fOBeEHWcFZc/IjFHbIpu1FgUelLWX1SsVaPKeaRhsKubLijOhspBQA7'></li>
        <li><input type=button value="Generate_HGR" onclick="generate_HGR();document.getElementById('FSL').focus();oPALETTE.draw_rainbow();update_param();oPALETTE.clear_layer(1);;oVoronoi.render();oPALETTE.draw_colormatches()" style='vertical-align:top; margin:4px 0px 0px 0px'></li>
        <li><input type=button value="Copy_Report" onclick="generate_HGR();document.getElementById('FSL').focus();oPALETTE.draw_rainbow();update_param();oPALETTE.clear_layer(1);;oVoronoi.render();oPALETTE.draw_colormatches();generate_REPORT()" style='vertical-align:top; margin:4px 0px 0px 0px'></li>
      </ul>
    </div>
    <div id=main>

<table><tr>
  <td style="vertical-align:top">
    <div id=mainPalette></div>
    <div id="results" style="margin-top:150px"></div>
    <div id=disp_param3 class="slider" style="width:100px"></div><button class=smallbutton onclick="document.getElementById('param3').value--;update_param();oPALETTE.clear_layer(1);oVoronoi.render();oPALETTE.draw_colormatches();">&larr;</button><input type="range" min="-1" max="0" value="-1" class="slider" id="param3" step=1 style="width:290px;height:20px;margin-top:10px;" oninput="update_param();oPALETTE.clear_layer(1);oVoronoi.render();oPALETTE.draw_colormatches();"><button class=smallbutton onclick="document.getElementById('param3').value++;update_param();oPALETTE.clear_layer(1);oVoronoi.render();oPALETTE.draw_colormatches();">&rarr;</button><br><br>
    <div id=debug style="overflow:scroll; height:400px;"></div>
  </td>
  <td style=vertical-align:top;><canvas class="appvid" id="applescreen" width="560" height="384"></canvas>
    <br>
    <input type=button value="prev" onclick="document.getElementById('param4').value--;update_param();generate_HGR();document.getElementById('FSL').focus();" style='vertical-align:top; margin:4px 0px 0px 0px'>
    <input type=button value="next" onclick="document.getElementById('param4').value++;update_param();generate_HGR();document.getElementById('FSL').focus();" style='vertical-align:top; margin:4px 0px 0px 0px'>
    <input id=param4 value=0 hidden>
  </td>
</tr></table>


  </div>
  </div>
</body>
</html>