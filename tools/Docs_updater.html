<html>
<head>
    <meta charset='utf-8'>
    <script type="text/javascript" src="../res/showdown.js"></script>
    <link rel="stylesheet" href="../res/COM_markdown.css">
</head>
<body>

<script>

  GetHTTP("https://raw.githubusercontent.com/RetroAppleJS/AppleII-IDE/main/README.md",
  function() { process_dir(this.responseText,this.responseURL) } )

  function GetHTTP(url,callback_function)
  {
    // random value (workaround to avoid caching)
    var r = ""; //"?"+btoa(Math.round(Math.random(1)*6*6*6)+"").replace(new RegExp("=","g"),"");
    const xhttp = new XMLHttpRequest();
    xhttp.onload = callback_function;
    xhttp.open("GET", url+r);
    xhttp.send();
  }

  function Markdown2HTML(md)
  {
    var converter = new showdown.Converter();
    converter.setFlavor("github");
    return converter.makeHtml(md);
  }

  function HTML2Markdown(html)
  {
    var converter = new showdown.Converter();
    converter.setFlavor("github");
    return converter.makeMarkdown(html);
  }

  //                                                     /res/appleIIplus_bck_650.png?raw=true
  // https://github.com/RetroAppleJS/AppleII-IDE/raw/main/res/appleIIplus_bck_650.png?raw=true

  function process(txt,url)
  {
    //var converter = new showdown.Converter();
    //converter.setFlavor("github");
    filename = url.substring(url.lastIndexOf("/")+1,url.length);

    //////////////////// MAKE HTML  //////////////////
    var html = Markdown2HTML(txt);
    html = html.replace(new RegExp('/res/','g'),"https://github.com/RetroAppleJS/AppleII-IDE/raw/main/res/");
    document.getElementById("src").innerHTML      = txt;
    document.getElementById("html_txt").innerHTML = html;
    document.getElementById("html").innerHTML     = html;

    //////////////////// MAKE MARKDOWN //////////////////
    document.getElementById("markdown").innerHTML = HTML2Markdown(html);
    //var html = "<p>TEST</p>";
    var js = "DOCS_"+filename.replace(new RegExp('.md','g'),"")
      +' = "'+(html.replace(new RegExp('\"','g'),'\\"')
                  .replace(new RegExp('\n','g'),"<br>\"\n+\"")
              +"<br>"+"\"\n\n")
              .replace(new RegExp('<br /><br>','g'),"<br>")
              .replace(new RegExp('..https://github.com/RetroAppleJS/AppleII-IDE/raw/main/res/','g'),"res/")
              .replace(new RegExp('</h1>','g'),"</h1><hr>")
              .replace(new RegExp('</h1>','g'),"</h1><hr>")
              .replace(new RegExp('</h2>','g'),"</h2><hr>")
              //.replace(new RegExp('<a ','g'),">")
              .replace(new RegExp('><br>','g'),">")
              .replace(new RegExp('<img ','g'),"<img style=\\\"-webkit-filter: invert(1) sepia(0.75) brightness(0.75) hue-rotate(110deg) brightness(1.3);filter: invert(1) sepia(0.75) brightness(0.75) hue-rotate(110deg) brightness(1.3);\\\" ")
     
    document.getElementById("dest").innerHTML += js;
    //download('DOCS.js',decodeURIComponent(js));
  }

  function process_dir(txt,url)
  {
    //document.write("<textarea>"+txt+"</textarea>")
    var linkURL = "https://github.com/RetroAppleJS/AppleII-IDE/blob/main/docs/";
    var rawURL = "https://raw.githubusercontent.com/RetroAppleJS/AppleII-IDE/main/docs/";
    var arr = txt.split(linkURL);

    arr[0] = ""; //alert(arr.join("\n"));
    for(var i=1;i<arr.length;i++)
    {
      arr[i] = arr[i].substring(0,arr[i].indexOf(".md")+3);
      var url = rawURL + arr[i]
      GetHTTP(url, function() { process(this.responseText,this.responseURL) } );
    }
  }

  function toMD(txt,url)
  {
    document.getElementById("dest").innerHTML   = HTML2Markdown(txt);
  }

  function download(filename, text)
  {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

  
</script>

<table>
<tr>
  <td><textarea id=src style="width:600px;height:180px"></textarea></td>
  <td>>></td>
  <td><textarea id=html_txt style="width:600px;height:180px"></textarea></td>
</tr>
<tr>
  <td><div id=html style="width:600px;height:180px;overflow:scroll;border: 1px solid black;font-size: 13px;"></div></td>
  <td>>></td>
  <td><textarea id=markdown style="width:600px;height:180px"></textarea></td>
</tr>
</table>
<textarea id=dest style="width:1200px;height:180px"></textarea>

<button onclick="download('_GENERATED_DOCS.js',document.getElementById('dest').innerHTML)">Download</button>

</body>
</html>

