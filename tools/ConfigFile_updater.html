<html>
<head>
    <meta charset='utf-8'>
    <script type="text/javascript" src="../res/showdown.js"></script>
    <link rel="stylesheet" href="../res/COM_markdown.css">
</head>
<body>

<script>

//  ██ ███    ██ ██ ████████ 
//  ██ ████   ██ ██    ██    
//  ██ ██ ██  ██ ██    ██    
//  ██ ██  ██ ██ ██    ██    
//  ██ ██   ████ ██    ██   


  var basepath = "RetroAppleJS/RetroAppleJS.github.io";         // repository-specific

  var rawURL = "https://raw.githubusercontent.com/"+basepath;   // github-specific
  var comURL = "https://github.com/"+basepath

  var resURL      = comURL+"/raw/main/res/"                      // directory-specific
  var blobURL     = comURL+"/blob/"
  //var rawMainURL  = rawURL+"/main/";
  var rawDocsURL  = rawURL+"/main/docs/";
  var blobDocsURL = blobURL+"main/docs/";

  var regexURL = escapeRegExp(".."+resURL);                       // regexp specific
  //document.write(regexURL+"<br>");

  var js; //,last_el;
  var el_cnt = 0;

//  ███    ███  █████  ██ ███    ██ 
//  ████  ████ ██   ██ ██ ████   ██ 
//  ██ ████ ██ ███████ ██ ██ ██  ██ 
//  ██  ██  ██ ██   ██ ██ ██  ██ ██ 
//  ██      ██ ██   ██ ██ ██   ████ 



GetHTTP(rawDocsURL+"CONFIG.md",function() { process_dir(this.responseText,this.responseURL) } )
GetHTTP(rawDocsURL+"CONFIG.md",
  function() 
  {
    process_table(["[PCODE]","\|","\n|","\|\n\n"],"_CFG_PCODE",this.responseText,this.responseURL);
    process_table(["[SLOT#]" ,"\|","\n|","\|\n\n"],"_CFG_SLOT",this.responseText,this.responseURL);
  } 
)
  




//  ███    ███  █████  ██ ███    ██     ███████ ██    ██ ███    ██  ██████ ████████ ██  ██████  ███    ██ ███████ 
//  ████  ████ ██   ██ ██ ████   ██     ██      ██    ██ ████   ██ ██         ██    ██ ██    ██ ████   ██ ██      
//  ██ ████ ██ ███████ ██ ██ ██  ██     █████   ██    ██ ██ ██  ██ ██         ██    ██ ██    ██ ██ ██  ██ ███████ 
//  ██  ██  ██ ██   ██ ██ ██  ██ ██     ██      ██    ██ ██  ██ ██ ██         ██    ██ ██    ██ ██  ██ ██      ██ 
//  ██      ██ ██   ██ ██ ██   ████     ██       ██████  ██   ████  ██████    ██    ██  ██████  ██   ████ ███████
 


  function process_table(markers,varName,text,url)
  {
    var pos = text.indexOf(markers[0]); // find table start
    var str = text.substring(pos,text.length);
    var pos2 = str.indexOf(markers[3]);
    var table = str.substring(0,pos2).replace(/\\(.)/g,"$1")
    var arr = table.split(markers[2]);
    
    // PARSE HEADERS
    var header_arr = arr[0].split(markers[1]);
    for(var i=0;i<header_arr.length;i++)
      header_arr[i] = trim(header_arr[i])

    // PARSE TABLE
    var q = "\"" 
    var table_struct = "const "+varName+" = {\n";
    

    for(var i=2;i<arr.length;i++)
    {

      var row = arr[i].split(markers[1]);
      var fieldName = trim(row[0]).replace(/\\(.)/g,"$1");
      table_struct+=  (i==2?"":",")
                    +(isNaN(Number(fieldName))?(q+fieldName+q):fieldName)
                    +":\n {"
      for(var j=1;j<row.length-1;j++)
      {
        table_struct+=(j==1?"":" ,")+q+header_arr[j]+q+":"+q+trim(row[j])+q+"\n"
      }
      table_struct+=" }\n"
    }
    
    var s = table_struct;
    //var s="";
    //s+= arr[0]
    s+="\n\n";


    // PARSE TABLE
    //for(i=j;i<arr.length;i++)
    

    document.getElementById('dest_html').innerHTML += s;
    document.getElementById('dest').innerHTML += s;
  }

  function process_dir(txt,url)
  {
    //document.write("<textarea>"+txt+"</textarea>")
    var arr = txt.split(blobDocsURL);    // Select all links pointing to /main/docs directory

    arr[0] = ""; //alert(arr.join("\n"));
    js = "var _DOCS = new Array();\n"

    //var lst = [];
    for(var i=1;i<arr.length;i++)
    {
      arr[i] = arr[i].substring(0,arr[i].indexOf(".md")+3);
      var url = rawDocsURL + arr[i];

      console.log("URL = "+url);
      GetHTTP(url, function() { process(this.responseText,this.responseURL) } );
      //lst[lst.length] = arr[i];
    }
    el_cnt = i-1;
  }

  function process(txt,url)
  {
    filename = url.substring(url.lastIndexOf("/")+1,url.length);

    //////////////////// MAKE HTML  //////////////////
    var html = Markdown2HTML(txt);

    html = html.replace(new RegExp('/res/','g'),resURL);
    

    document.getElementById("src").innerHTML      = txt;
    document.getElementById("html_txt").innerHTML = html;
    document.getElementById("html").innerHTML     = html;

    //////////////////// MAKE MARKDOWN //////////////////
    document.getElementById("markdown").innerHTML = HTML2Markdown(html);
    //var html = "<p>TEST</p>";

    var js1 = "_DOCS[\""+filename.replace(new RegExp('.md','g'),"")+"\"]"+' = "'
    var js2 = (html.replace(new RegExp('\"','g'),'\\"').replace(new RegExp('\n','g'),"<br>\"\n+\"")+"<br>"+"\"\n\n")  
    var js3 = js2.replace(new RegExp('<br /><br>','g'),"<br>")
    var js4 = js3.replace(new RegExp(regexURL,'g'),"res/")
    console.log("js4 = "+js4);


               //.replace(new RegExp('..https://github.com/RetroAppleJS/AppleII-IDE/raw/main/res/','g'),"res/")
  
    js += js1 + js4.replace(new RegExp('</h1>','g'),"</h1><hr>")
              .replace(new RegExp('</h1>','g'),"</h1><hr>")
              .replace(new RegExp('</h2>','g'),"</h2><hr>")
              .replace(new RegExp('><br>','g'),">")
              
    el_cnt--;

    //js += "\nalert(typeof(_DOCS))\n";
    if(el_cnt==0)
    {
        js = js.replace(new RegExp("res/","g"),resURL)
        document.getElementById("dest").innerHTML += js;

        //js += "for(var i in _DOCS) {document.getElementById('dest_html').innerHTML += _DOCS[i]+'<br><hr><a href=>NEXT</a><hr><br>'}"
        eval(js);
        var c = 0;
        var s = "";
        for(var i in _DOCS)
        {
          s +=
          '<br><hr id=_DOCS_'+(c)+'><big><a href="#_DOCS_'+(c+1)+'">NEXT</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="#_DOCS_0">TOP</a></big><hr>\n'
          +_DOCS[i]
          c++;
        }
        document.getElementById('dest_html').innerHTML += s
        document.getElementById('dest_html2').innerHTML += s
    }
    //download('DOCS.js',decodeURIComponent(js));
  }



//  ████████ ██████   █████  ██ ██          ███████ ██    ██ ███    ██  ██████ ████████ ██  ██████  ███    ██ ███████ 
//     ██    ██   ██ ██   ██ ██ ██          ██      ██    ██ ████   ██ ██         ██    ██ ██    ██ ████   ██ ██      
//     ██    ██████  ███████ ██ ██          █████   ██    ██ ██ ██  ██ ██         ██    ██ ██    ██ ██ ██  ██ ███████ 
//     ██    ██   ██ ██   ██ ██ ██          ██      ██    ██ ██  ██ ██ ██         ██    ██ ██    ██ ██  ██ ██      ██ 
//     ██    ██   ██ ██   ██ ██ ███████     ██       ██████  ██   ████  ██████    ██    ██  ██████  ██   ████ ███████ 


  function ltrim(s) { return s.replace(/^ */,"") }
  function rtrim(s) { return s.replace(/ *$/,"") }
  function trim(s)  { return rtrim(ltrim(s)) }

  function Markdown2HTML(md)
  {
    var converter = new showdown.Converter();
    converter.setFlavor("github");
    return converter.makeHtml(md);
  }

  function HTML2Markdown(html)
  {
    var converter = new showdown.Converter();
    converter.setFlavor("github");
    return converter.makeMarkdown(html);
  }

  function GetHTTP(url,callback_function)
  {
    // random value (workaround to avoid caching)
    var r = ""; //"?"+btoa(Math.round(Math.random(1)*6*6*6)+"").replace(new RegExp("=","g"),"");
    const xhttp = new XMLHttpRequest();
    xhttp.onload = callback_function;
    xhttp.open("GET", url+r);
    xhttp.send();
  }

  function download(filename, text)
  {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

  function escapeRegExp(text) { return text.replace(/([\[\/\]\{\}\(\)\*\+\?\.\,\\\\^\$\|\#])/g, '\\$1')}


</script>

<table hidden>
<tr>
  <td><textarea id=src style="width:600px;height:180px"></textarea></td>
  <td>>></td>
  <td><textarea id=html_txt style="width:600px;height:180px"></textarea></td>
</tr>
<tr>
  <td><div id=html style="width:600px;height:180px;overflow:scroll;border: 1px solid black;font-size: 13px;"></div></td>
  <td>>></td>
  <td><textarea id=markdown style="width:600px;height:180px"></textarea></td>
</tr>
</table>
<textarea id=dest style="width:1200px;height:180px"></textarea>
<br>
<button onclick="download('COM_CONFIG.js',document.getElementById('dest').value)">Download</button>
<table width="700px" cellspacing="0" cellpadding="0" style="background-color:#76B9CE;border-radius:10px;">
  <tr>
  <td style="background-image:url('../res/CRT_TV_50b.png');background-size:800px 560px;background-repeat:no-repeat;image-rendering:pixelated;vertical-align:top">
    <div style="height:90px"></div>
    <div contenteditable="true" class=markdown_mon id=dest_html></div>
    <div style="height:180px"></div>
  </td>
  <td style="background-size:800px 560px;background-repeat:no-repeat;image-rendering:pixelated;vertical-align:top">
    <div contenteditable="true" class=markdown id=dest_html2></div>
  </td>
</tr>
</table>
</body>
</html>
