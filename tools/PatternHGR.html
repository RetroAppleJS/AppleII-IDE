<html style="background-color:#B0B0B0"><head>
  <title>HGR PATTERN GENERATOR</title>
  <meta name="description" content="">
  <meta name="author" content="Freddy Vandriessche">
  <meta charset="utf-8">
  <style>
  html {height:100%;font-family:"Arial"}
  body {background-color:#808080;height:100%;margin:0px;padding:0px}
  .tcell10 {width:10px;height:10px;background-color:white;padding:0;border:1px solid white}
  .tcell10:hover { width:10px;height:10px;background-color:yellow;border:1px solid black }
  .tcell5 {width:5px;height:10px;background-color:lightgray;padding:0;border:0px solid white}
  .tcell5:hover { width:5px;height:10px;background-color:yellow;border:0px solid white}

  .leftpane {Â width:400px;  }

  /* vertical-align:top; margin:4px 0px 0px 0px; overflow-wrap:anywhere; */

  .tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: black;
  color: #fff;
  text-align: center;
  border-radius: 6px;
  padding: 5px 0;

  /* Position the tooltip */
  position: absolute;
  z-index: 1;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
}

#MyCanvas {
border:1px solid black;
}


  </style>
</head>

<script type="text/javascript" src="../res/EMU_apple2video.js"></script>
<script type="text/javascript" src="../res/EMU_apple2hw.js"></script>
<script type="text/javascript" src="../res/EMU_apple2io.js"></script>
<script type="text/javascript" src="../res/palette.js"></script>  

<script>

// TODO CLICKING HIGH-BIT DOES NOT RENDER ALTERNATE COLORS !!!

/////////////////////////////////////////////////////////
// INITIALISE DATA

var CONF_version="";
var CONF_builddate="";  

var _D = 
{
    "hpat":10  // horizontal hgr pattern count
    ,"vpat":6   // vertical hgr pattern count
    ,"leftpane":430  // size of left pane (grid)
    ,"bmapx":28  // grid width
    ,"bmapy":4   // grid height
    ,"bmapID":0  // location of editable grid
    ,"YVERTL":"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"
              +"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"
              +"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"
    ,"YVERTH":"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
              +"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
              +"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
}
var yref = new Array();
  for(var i=0;i<_D.YVERTL.length;i+=2)
    yref[i/2] = parseInt( _D.YVERTH.substring(i,i+2),16)*256
               +parseInt( _D.YVERTL.substring(i,i+2),16);


oPATTERN = new PATTERN();
var custom_bmap =  new Array(_D.bmapx).fill([false,0]).map(() => new Array(_D.bmapy).fill([false,0]));
var custom_fmla = ["",""];
var loresCols = [];

var oPALETTE = new PALETTE();

/////////////////////////////////////////////////////////
// ONLOAD

function init_gui(_o)
{
  document.getElementById('slider_title').outerHTML = _TITLE();
  vidContext          = document.getElementById('applescreen').getContext("2d");
  apple2plus          = new Apple2Plus(vidContext);

  var a = oPATTERN.parse(), s = "", sep = " ; ";
  for(var i in a) s+= "<option value=\""+i+sep+a[i][0]+sep+a[i][1]+sep+"\">\n";
  document.getElementById("formulas").innerHTML = s;

  oPALETTE.load(["#682172","#68350D","#174A72","#97DD8C","#E7A1F2","#E7B48C","#97CAF2","#7F7F7F","#7F931A","#2FA87F","#D0567F","#7F6CE5"])
  oPALETTE.insert_canvas({"id":"mainPalette","width":430,"height":150});

  generate_GRIDS();
  generate_HGR();

  oPALETTE.draw_rainbow();
  oPALETTE.draw_colormatches();
}

/////////////////////////////////////////////////////////
// CALL FUNCTIONS

var vidContext, apple2plus;
function Apple2Plus(context)
{
  this.video = new Apple2Video(context);
  this.hw    = new Apple2Hw(this.video);
  // Switch on Apple II Hi-Res graphics
  this.video.reset();
  this.video.setGfx(true);
  this.video.setHires(true);
  this.video.redraw();
  loresCols = this.video.getloresCols();
}

var hextab= ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F']; 
function getHexByte(v) { return hextab[v>>4]+hextab[v&0xf] }

function PATTERN(idx,x,y)
{
    this.calulate = PATTERN_calculate;
    this.parse = PATTERN_parse;
    this.color = PATTERN_color;
    this.color_arr = [];

    function ltrim(s) { return s.replace(/^ */,"") }
    function rtrim(s) { return s.replace(/ *$/,"") }
    function trim(s) { return rtrim(ltrim(s)) }

    function editable_map(x,y)
    {
      if(x<0) return [false,0];
      return custom_bmap[x%_D.bmapx][y%_D.bmapy];
    }

    function PATTERN_calculate(idx,x,y)
    {
      // output = [color_index, pixel_decision, high_bit ]
      switch(idx)
      {
        case 0:  return  [0,editable_map(x,y)[0],editable_map(x,y)[1]];
        //case 1:  return  [0,eval(custom_fmla[0]),eval(custom_fmla[1])];
        //case 2:  return  [loresCols[0][0],false,0];                 // black 1 
        case 1:  return  [loresCols[1][0],(x+1)%2==0,0];            // green 
        case 2:  return  [loresCols[2][0],x%2==0,0];                // purple
        case 3:  return  [loresCols[3][0],true,0];                  // white 1  
        case 4:  return  [loresCols[4][0],false,128];               // black 2
        case 5:  return  [loresCols[5][0] ,(x+1)%2==0,128];         // orange
        case 6:  return  [loresCols[6][0],x%2==0,128];              // blue
        case 7:  return  [loresCols[7][0],true,128];                // white2 2

        case 10: return  [4 ,(x+1)%2==0 && y%2==0,0];  // dark green 
        case 11: return  [3 ,x%2==0 && y%2==0,0];      // dark purple       
        case 12: return  [9 ,(x+1)%2==0 && y%2==0,128];// dark orange
        case 13: return  [2 ,x%2==0 && y%2==0,128];    // dark blue
        case 14: return  [4 ,(x+1)%2==0 || y%2==0,0];  // dark green 
        case 15: return  [3 ,x%2==0 || y%2==0,0];      // dark purple    
        case 16: return  [9 ,(x+1)%2==0 || y%2==0,128];// dark orange
        case 17: return  [2 ,x%2==0 || y%2==0,128];    // dark blue
        case 18: return  [15 ,y%2==0,0];

        case 20: return  [4 ,(x+1)%2==0 && y%2==0 || x%2==0 && y%2!=0,0];
        case 21: return  [4 ,(x+1)%2==0,y%2!=0?128:0];
        case 22: return  [4 ,(x+1)%2==0 && y%2==0 || x%2==0 && y%2!=0,y%2!=0?128:0];
        case 23: return  [4 ,x%2==0 && y%2==0 || (x+1)%2==0 && y%2!=0,y%2!=0?128:0];
        case 24: return  [4 ,x%2==0,y%2!=0?128:0];
        case 25: return  [4 ,(x+1)%2==0 && y%2==0 || x%2==0 && y%2!=0,128];
        case 26: return  [15 ,(y&1)==0 && (x&3)==0 || (y&1)==1 && (x&3)==2 ,0];
        case 27: return  [15 ,(y&1)==0 && (x&3)==1 || (y&1)==1 && (x&3)==3 ,0];
        case 28: return  [15 ,(y&1)==0 && (x&3)==0 || (y&1)==1 && (x&3)==2 ,128];
        case 29: return  [15 ,(y&1)==0 && (x&3)==1 || (y&1)==1 && (x&3)==3 ,128];          

        case 30: return  [15 ,y%2==0 && ( (x>>1)%2!=0 || (x+1)%2==0) || y%2!=0 && (x+1)%2!=0,0]; 
        case 31: return  [15 ,y%2==0 && ( (x>>1)%2!=0 || (x+1)%2==0) || y%2!=0 && x%2!=0,y%2!=0?128:0];   
        case 32: return  [15 ,y%2==0 && ( (x>>1)%2!=0 || (x+1)%2==0) || y%2!=0 && (x+1)%2!=0,y%2!=0?128:0]; 
        case 33: return  [15 ,y%2==0 && ( (x>>1)%2!=0 || (x)%2==0)   || y%2!=0 && x%2!=0,y%2!=0?128:0];  
        case 34: return  [15 ,y%2==0 && ( (x>>1)%2!=0 || (x)%2==0)   || y%2!=0 && (x+1)%2!=0,y%2!=0?128:0]; 
        case 35: return  [15 ,y%2==0 && ( (x>>1)%2!=0 || (x+1)%2==0) || y%2!=0 && (x+1)%2!=0,128];  
        case 36: return  [15 ,y%2==0 && ( (x>>1)%2!=0 || (x+1)%2==0) || y%2!=0 && x%2!=0,y%2==0?128:0];
        case 37: return  [15 ,(x%2==0 || (x+1)%4==0) && y%2==0 || (x%2==0 || (x+2)%4==0) && y%2!=0,y%2==0?128:0 ];

        case 38: return  [4 ,(x%5==0 || (x+2)%5==0 || (x+3)%5==0) && y%2==0 || ((x+1)%5==0 || (x+3)%5==0 || (x+4)%5==0) && y%2!=0  ,0];
        case 39: return  [4 ,(x%11==0 || (x-2)%11==0 || (x-3)%11==0 || (x-4)%11==0 || (x-6)%11==0 || (x-8)%11==0 || (x-9)%11==0) && y%2==0
                          || ((x-6)%11==0 || (x-8)%11==0 || (x-5)%11==0 || (x-6)%11==0 || (x-8)%11==0 || (x-10)%11==0 || (x-11)%11==0) && y%2!=0 ,0];
        // 0 2 3 4 6 8 9
        //  110101101011

        case 40: return  [15, ((x+1)%2==0 || x%10==0) && y%2==0 || (x%2==0 || (x+5)%10==0) && y%2!=0,0];
        case 41: return  [15, ((x+1)%2==0 || x%10==0) && y%2==0 || (x%2==0 || (x+5)%10==0) && y%2!=0,128];
        case 42: return  [15, ((x+1)%2==0 || x%10==0) && y%2==0 || (x%2==0 || (x+5)%10==0) && y%2!=0,y%2==0?128:0];
        case 43: return  [15, ((x+1)%2==0 || x%10==0) && y%2==0 || (x%2==0 || (x+5)%10==0) && y%2!=0,y%2!=0?128:0];
        case 44: return  [15, ((x+1)%2==0 || x%10==0) && y%2==0 || ((x+1)%2==0 || (x+6)%10==0) && y%2!=0,y%2==0?128:0 ];
        case 45: return  [15, (x%2==0 || (x+1)%10==0) && y%2==0 || (x%2==0 || (x+5)%10==0) && y%2!=0,y%2==0?128:0 ];
        case 46: return  [15 ,(y&1)==0 && (x&3)==1 || (y&1)==1 && (x&3)==3 ,(y&1)<<7];
        case 47: return  [15 ,(y&1)==0 && (x&3)==0 || (y&1)==1 && (x&3)==2 ,(y&1)<<7];


        case 50: return  [15, (x%2==0 || (x+1)%4==0) && y%2==0 || (x%2==0 || (x+3)%4==0) && y%2!=0,0 ];
        case 51: return  [15, ((x+1)%2==0 || (x+2)%4==0) && y%2==0 || ((x+1)%2==0 || (x+4)%4==0) && y%2!=0,0 ];
        case 52: return  [15, ((x+1)%2==0 || (x+2)%4==0) && y%2==0 || ((x+1)%2==0 || (x+4)%4==0) && y%2!=0,y%2==0?128:0 ];
        case 53: return  [15, (x%2==0 || (x+1)%4==0) && y%2==0 || (x%2==0 || (x+3)%4==0) && y%2!=0,y%2==0?128:0 ];
        case 54: return  [15 ,y%2==0 && (x>>1)%2!=0 || y%2!=0,0];

        case "": return  [loresCols[3][0],true,0];
        default: return [0,false,0];  
      }
  }

  function PATTERN_color(patternID)
  {
    // sample multiplier
    var m = 1;
    var col_m = 255 * m * m * _D.bmapx * _D.bmapy;
    var max_sum = [col_m,col_m,col_m];
    var col_sum = [0,0,0];

      for(var y=0;y<_D.bmapy*m;y++)
      {
        for(var x=0;x<_D.bmapx*m;x++)
        {
          var left = PATTERN_calculate(patternID,x-1,y)[1];
          var me = PATTERN_calculate(patternID,x,y)[1];
          var right = PATTERN_calculate(patternID,x+1,y)[1];
          var b7 = PATTERN_calculate(patternID,x,y)[2];
          var col = getPixelColor_HGR(x, y, left, me, right, b7);
          col_sum = [ col_sum[0] + parseInt(col.substring(1,3),16)
                    , col_sum[1] + parseInt(col.substring(3,5),16)
                    , col_sum[2] + parseInt(col.substring(5,7),16)];
        }
      }
      //var a = [col_sum[0]/max_sum[0]*255, col_sum[1]/max_sum[1]*255, col_sum[2]/max_sum[2]*255 ]
      //alert("#"+getHexByte(a[0])+getHexByte(a[1])+getHexByte(a[2]))

      return [col_sum[0]/max_sum[0]*255, col_sum[1]/max_sum[1]*255, col_sum[2]/max_sum[2]*255 ];
  }


  function PATTERN_parse()
  {
    // PARSE PATTERN FUNCTION - CASE BY CASE
    var formula_list = String(PATTERN_calculate).split("return");
    var formula_ref = {};
    for(var i=1;i<formula_list.length;i++)
    {
      var casenr = formula_list[i-1].split("case")[1];
      var triple = trim( formula_list[i].substring(0,formula_list[i].indexOf(";")) );
      
      /*
      array = [], c = 0;
      'abc(cba)ab(bac)c'.split(/([()])/).filter(Boolean).forEach(e =>
      // Increase / decrease counter and push desired values to an array
      e == '(' ? c++ : e == ')' ? c-- : c > 0 ? array.push('(' + e + ')') : array.push(e)
      );
      */
      
      var arr = triple.split(/([()])/);
      var levels = []; c =0;
      for(var l=0;l<arr.length;l++)
      {levels.push(c==0?arr[l].replace(/,/g,",,,,,"):arr[l]) ; c+=(arr[l]=='('?1:0) + (arr[l]==')'?-1:0);   }
      
      if(typeof(casenr)=="string" && casenr.indexOf(":")>0 && triple.charAt(0)=="[")
      {
        casenr = Number(casenr.substring(0,casenr.indexOf(":")));
        //var fml = triple.split(",");
        var fml = levels.join("").split(",,,,,")
        formula_ref[casenr] = [ fml[1] , fml[2].substring(0,fml[2].lastIndexOf("]")) ];  // TODO fix EOL sign !
        //formula_ref[casenr] = [ fml[1] , fml[2] ];  // TODO fix EOL sign !
      }
    }
    return formula_ref
  }
}

function setPixel_HGR(x,y,patternID)
{
    // find address and bit location
    var adr = yref[y] + Math.floor(x/7);              // find address 
    var rbyt = apple2plus.hw.read(adr);
    var wbyt = rbyt | (1 << x%7);                     // OR current bit with pixel bit
    if(rbyt ==0 && rbyt&8 != oPATTERN.calulate(patternID,x,y)[2])
      wbyt |= oPATTERN.calulate(patternID,x,y)[2];    // OR high bit
    else
    {
      wbyt |= oPATTERN.calulate(patternID,x,y)[2];
      //document.getElementById("debug").innerHTML += "CONFLICT "+PRINTByte(rbyt)+" >> "+PRINTByte(wbyt)
    }  // Hi-Byte conflict !!

    if(oPATTERN.calulate(patternID,x,y)[1])
        apple2plus.hw.write(adr,wbyt);                    // write byte 
}

function clearPixel_HGR(x,y)
{
    // find address and bit location
    var adr = yref[y] + Math.floor(x/7);              // find address 
    var rbyt = apple2plus.hw.read(adr);
    var wbyt = rbyt & ~(1 << x%7) & 127;              // AND current bit with pixel bit
    apple2plus.hw.write(adr,wbyt);                    // write byte 
}

function getPixel_HGR(x,y)
{
    // find address and bit location
    var adr = yref[y] + Math.floor(x/7);              // find address 
    var rbyt = apple2plus.hw.read(adr);
    var bit = (rbyt >> (x%7)) & 1 == 1;
    bit = x<0 || x>279 ? 0 : bit;                     // 
    var b7  = rbyt & 128;
    return [ bit,b7 ]
}

function getPixelColor_HGR(x, y, left, me, right, b7) {
        var a0 = x & 0x01;
        // If pixel is set and either adjacent pixels are set, it's white.
        if (me != 0 && (left != 0 || right != 0))
            return loresCols[15][0];  // White
        // If pixel is set but no adjacent pixels are set, pick a color
        // based on column and b7.
        else if (me != 0) {
            if (b7 != 0) {
                if (a0 != 0)
                    return loresCols[9][0]; // Orange
                else
                    return loresCols[6][0]; // Medium Blue
            } else {
                if (a0 != 0)
                    return loresCols[12][0]; // Green
                else
                    return loresCols[3][0]; // Purple
            }
        }
        // If pixel is not set and both adjacent pixels are set, pick a
        // color based on column (of adjacent pixel) and b7 (of this byte).
        else if (left != 0 && right != 0) {
            if (b7 != 0) {
                if (a0 != 0)
                    return loresCols[6][0]; // Medium Blue
                else
                    return loresCols[9][0]; // Orange
            } else {
                if (a0 != 0)
                    return loresCols[3][0]; // Purple
                else
                    return loresCols[12][0]; // Green
            }
        }
        // Else it's black.
        else
           return loresCols[0][0];    // Black
    }


function wipe_HGR(byte)
{
    // find address and bit location
    //var adr = yref[y] + Math.floor(x/7);              // find address 
    //var wbyt = apple2plus.hw.read(adr) | 1 << x%7;    // OR current bit with pixel bit
    for(var adr=8192;adr<16384;adr++)
    apple2plus.hw.write(adr,byte);                    // write byte 
}

function PRINTByte(by)
{
  var sa = ("0000000"+by.toString(2)).slice(-8).split("");
  //sa = sa.reverse();
  var styl = " style='padding:5px;border:1px solid;font-family:Arial'"
  return "<table style='border-collapse: collapse;'><tr><td"+styl+">"+sa.join("</td><td"+styl+">")+"</td></tr></table>"
}

function Cpix(t,x,y,z)
{ 
  if(z==0)
    custom_bmap[x][y] = [ custom_bmap[x][y][0]?false:true, custom_bmap[x][y][1]];
  else
  {
     for(var i=x;i>(x-7);i--)
        custom_bmap[i][y] = [ custom_bmap[i][y][0], custom_bmap[i][y][1]==0?128:0];
  }
  var o=t.parentNode.style; o.backgroundColor=o.backgroundColor?"":"green";
}

// SHOW BITMAP TABLES (LEFT PANE)
function generate_GRIDS()
{
  var im = "data:image/gif;base64,R0lGODlhAQABAPAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
  //var im = "../res/pixT.gif";
  var dot = ["<img src=\""+im+"\" style=\"width:9px;height:9px\" onclick=Cpix(this)>"
          ,"<img src=\""+im+"\" style=\"width:5px;height:9px\" onclick=Cpix(this)>"]
  // TODO: MODIFIERS - preset pattern -  load/save pattern)

  // PARSE PATTERN FUNCTION - CASE BY CASE
  formula_ref = oPATTERN.parse(); //parse_FORMULA()

  s= "<big><font color=white>BITMAP GRIDS<font></big><br><br>";
  for(var p=0;p<(_D.vpat*_D.hpat);p++)
  {
    var c = oPATTERN.color(p);    // calculate average color of patternID  
    var cs = "#"+getHexByte(c[0])+getHexByte(c[1])+getHexByte(c[2]);
    var cs2 = [Math.round(100*c[0]/255),Math.round(100*c[1]/255),Math.round(100*c[2]/255)];
    var tc = cs2[0]>90 && cs2[1]>90 && cs2[2]>90 ? "black":"white";
    oPALETTE.hex_pal[p] = cs;

    s+= "<div style='width:430px;background-color:"+cs+";color:"+tc+";vertical-align:top; margin:4px 0px 0px 0px; overflow-wrap:anywhere;'><big>"+p+"</big> "+cs+" "+cs2.join("% ")+"%<br>"+formula_ref[p]+"</div>";
    s+= "<table class=tcell style='margin:0;padding:0;border:1px solid "+(p==_D.bmapID?"red":"black")+";'>";
    for(var y=0;y<_D.bmapy;y++)
    {
      s+="<tr>";
      for(var x=0;x<_D.bmapx;x++) s+= gen_cell(p,x,y,p==_D.bmapID?dot:["",""]);
      s+="</tr>";
    }
    s+="</table><br>";
  }  
  document.getElementById("debug").innerHTML = s;



  // TODO >> fish color array !!! (oPATTERN.color(p))
  //draw();  // DOES NOT LOAD ???
}

function gen_cell(patternID,x,y,img)
{
  var c = oPATTERN.calulate(patternID,x,y);
  var bi = isNaN(patternID); 

  // TODO DEBUG color definitions
  if(patternID == _D.bmapID)
  {
    //console.log(x+" "+y+" "+_D.bmapx+" ")

    var left = x<=0 ? false : custom_bmap[x-1][y][0];
    var me = custom_bmap[x][y][0];
    var right = x>=(_D.bmapx-1) ? false : custom_bmap[x+1][y][0];
    var b7 = custom_bmap[x][y][1]==128?1:0;

    //var col = getPixelColor_HGR(x, y, left, me, right, b7)
    //var alt = "<span class=tooltiptext style=color:"+col+";font-size:8px>"+col+"("+[left,me,right,b7].join(",")+")</span>";
    var css = "tooltip "
    var alt = "";
    }
    else { alt = ""; css = ""}

    var pix = c[1]?"background-color:black":"";
    var bck = (c[2]==128?"border-color:#FFE9D0":"");
    var s= "<td class='"+css+"tcell10' alt=\""+alt+"\" style=\""+pix+";padding:0;"+bck+"\">"+img[0].replace(/this/g,"this,"+x+","+y+",0")+alt+"</td>"
    if((x+1)%7==0)
    s+= "<td class=tcell5 style=\""+(c[2]==128?"background-color:black":"")+"\">"+img[1].replace(/this/g,"this,"+x+","+y+",1")+"</td>"
    return s;
}


function generate_HGR()
{ 
    wipe_HGR(0);
    var pid = 0;
    var bls = [17,17];
    var spc = [10,10];

    for(var dy=0;dy<_D.vpat;dy++)
    {
            for(var dx=0;dx<_D.hpat;dx++)
            {

                // DRAW LEFT TOP SQUARE
                for(var x=-5;x<3;x++)
                {
                  for(var y=-5;y<1;y++)
                  {
                    setPixel_HGR(x+spc[0]+dx*(bls[0]+spc[0]),y+spc[1]+dy*(bls[1]+spc[1]),"");
                  }
                }

                // DRAW LINE SQUARE
                for(var x=-3;x<bls[0]+3;x++)
                {
                  setPixel_HGR(x+spc[0]+dx*(bls[0]+spc[0]),-4+spc[1]+dy*(bls[1]+spc[1]),"");
                  setPixel_HGR(x+spc[0]+dx*(bls[0]+spc[0]),-3+spc[1]+dy*(bls[1]+spc[1]),"");
                  setPixel_HGR(x+spc[0]+dx*(bls[0]+spc[0]),bls[1]+2+spc[1]+dy*(bls[1]+spc[1]),"");
                  setPixel_HGR(x+spc[0]+dx*(bls[0]+spc[0]),bls[1]+3+spc[1]+dy*(bls[1]+spc[1]),"");
                }
                for(var y=-3;y<bls[1]+3;y++)
                {
                  setPixel_HGR(-4+spc[0]+dx*(bls[0]+spc[0]),y+spc[1]+dy*(bls[1]+spc[1]),"");
                  setPixel_HGR(-3+spc[0]+dx*(bls[0]+spc[0]),y+spc[1]+dy*(bls[1]+spc[1]),"");
                  setPixel_HGR(bls[0]+2+spc[0]+dx*(bls[0]+spc[0]),y+spc[1]+dy*(bls[1]+spc[1]),"");
                  setPixel_HGR(bls[0]+3+spc[0]+dx*(bls[0]+spc[0]),y+spc[1]+dy*(bls[1]+spc[1]),"");
                }          

                // DRAW SOLID SQUARE
                for(var y=0;y<bls[1];y++)
                    for(var x=0;x<bls[0];x++)
                        setPixel_HGR(x+spc[0]+dx*(bls[0]+spc[0]),y+spc[1]+dy*(bls[1]+spc[1]),pid);
                pid++;
            }
    }  
    
}



/////////////////////////////////////////////////////////
// GUI TEMPLATE

var _T = function _T(idx,mod) {
this.t = {get _language(){ return "NL" }
,"title":document.title
,"menu_convert":""
,"menu_info":"Info/Contact"
,"intro":""
,"version":(CONF_version?("Version "+CONF_version):"")
,"built":(CONF_builddate?("Built "+CONF_builddate):"")
,get _(){return this}
}
if(idx.length>0 && typeof(this.t[idx])=="undefined") { alert(idx); return "<font color=red>"+idx+"</font>" }
switch(mod) {
  case "cap": return this.t[idx].charAt(0).toUpperCase()+this.t[idx].substring(1,this.t[idx].length);
  case "inv": { var j = {}; for(var i in t) { j[ t[i] ] = i }; return j } // inverse associative
  default: return this.t[idx];
}
}
function _D(idx) { if(typeof(_T(idx)=="string")) document.write(_T(idx)) }
function _TITLE() {
var css = "#texturespace {background: #f7f7f7 url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAEEAYAAAD5YUI9AAAACXBIWXMAAA4mAAAOJgGi7yX8AAAARElEQVQIHWPYyrxTed9eg3UQWkQHQgtaQGg5JgaohAdUoglC8z+A0mFQBYIpUIEXULoOQgvIQRXIBUElMqASShBaWQwApNg4NPAzQGwAAAAASUVORK5CYII=') repeat center top;font: 62.5%/1 sans-serif;height: 100%;width: 100%;}"
+"#carvetext {color: transparent;background: #f7f7f7;font: 62.5%/1 sans-serif;stroke: 2px rgba(0,0,0,0.2);background-color: rgba(140,140,140,1);-webkit-background-clip: text;text-shadow: rgba(255,255,255,0.5) 0 5px 6px, rgba(255,255,255,0.2) 1px 3px 3px;transition: text-shadow .1s ease-out, background-color .2s ease-out;}"
+"#carvetext:hover {color: transparent;background-color: rgba(82,96,117,0.5);-webkit-background-clip: text;text-shadow: rgba(255,255,255,0.5) 0 5px 6px;}"
+"#carvetext:focus {outline: none;}.slider_main {position: relative;height: 100%;}"
+".slider_overlay {position: absolute;bottom: 0;left: 0;right: 0;background-color: #A0A0A0;overflow: hidden;width: 100%;height: 85%;transition: .5s ease;}"
//+".slider_main:hover "
+".slider_overlay {height: 100%;}"
+"#topmenu{width:100%;background-color:#f0f0f0}"
+"ul#minitabs{list-style:none;margin:0;padding:3px 0 0 0;border-left:1px solid #ccc;border-right:1px solid #ccc;border-top:1px solid #ccc;border-bottom:1px solid #ccc;font-weight:700;text-align:left;white-space:nowrap}ul#minitabs li{display:inline;margin:0 3px}ul#minitabs a{text-decoration:none;color:#999}ul#minitabs a#current{border-color:#f60;color:#06f}ul#minitabs a:hover{border-color:#f60;color:#666}"

return "<style>"+css+".slider_overlay{height: 85%}</style>"
+"<div id=texturespace style='height:100%;width:100%'><center><div id='carvetext'>"
+"<div style='font-size:5em'>"+(typeof(_T("title"))=="string"?_T("title"):"")+"</div>"
+"<div style='font-size:1em'>"+(typeof(_T("version"))=="string"?_T("version"):"")
+" &nbsp; "+(typeof(_T("built"))=="string"?_T("built"):"")+"</div>"
+"</div></center></div>"
}



function load_bitmap()
{
  var sep = " ; "
  var sel = document.getElementById("FSL").value.split(sep);

  custom_fmla[0] = sel[1];
  custom_fmla[1] = sel[2];
  //var patternID = _D.bmapID; 

  // FILL custom_bmap using custom_fmla
  for(var y=0;y<_D.bmapy;y++)
  {
    for(var x=0;x<_D.bmapx;x++) 
      custom_bmap[x][y] = [eval(custom_fmla[0]),eval(custom_fmla[1])];
  }

  generate_GRIDS();
}
</script>

 <body class="slider_main" onload="init_gui();draw()">

<div id="slider_title"></div>
 <div class="slider_overlay">
    <div id="topmenu">
      <ul id="minitabs">
        <li>
          <input autofocus style=width:430px list="formulas" name="formula-selector" id="FSL" value="select a pattern here" onclick=this.value='' />
          <datalist id="formulas" >
          </datalist>
        </li>
        <li><input type=button value="load" onclick="load_bitmap();document.getElementById('FSL').focus()" style='vertical-align:top; margin:4px 0px 0px 0px'></li>
        <li><img src='data:image/gif;base64,R0lGODlhGAAYAPAAAF3/AAAAACH5BAEAAAAALAAAAAAYABgAAAJPhG+hiu0Y4JsnSvqsBRvXtHXVQmpM4ogN+V1T2aJcSZ9cW+c4mNOf2fOBeEHWcFZc/IjFHbIpu1FgUelLWX1SsVaPKeaRhsKubLijOhspBQA7'></li>
        <li><input type=button value="Generate_HGR" onclick="generate_HGR();document.getElementById('FSL').focus()" style='vertical-align:top; margin:4px 0px 0px 0px'></li>
      </ul>
    </div>
    <div id=main>

<table><tr>
  <td style="vertical-align:top">
    <div id=mainPalette></div>
    <div id="results" style="margin-top:150px"></div>
    <div id=debug style="overflow:scroll; height:400px;"></div>
  </td>
  <td style=vertical-align:top;><canvas class="appvid" id="applescreen" width="560" height="384"></canvas></td>
</tr></table>

  </div>
  </div>
</body>
</html>