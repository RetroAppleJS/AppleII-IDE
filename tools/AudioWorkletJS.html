<!--
//
// Copyright (c) 2024 Freddy Vandriessche.
// notice: https://raw.githubusercontent.com/RetroAppleJS/AppleII-IDE/main/LICENSE.md
//        _                     __   _                                       
//       / \                   |  ] (_)                                      
//      / _ \    __   _    .--.| |  __   .--.                                
//     / ___ \  [  | | | / /'`\' | [  |/ .'`\ \                              
//   _/ /   \ \_ | \_/ |,| \__/  |  | || \__. |                              
//  |____| |____|'.__.'_/ '.__.;__][___]'.__.'                               
//   ____      ____              __       __         _      _____   ______   
//  |_  _|    |_  _|            [  |  _  [  |       / |_   |_   _|.' ____ \  
//    \ \  /\  / / .--.   _ .--. | | / ]  | | .---.`| |-'    | |  | (___ \_| 
//     \ \/  \/ // .'`\ \[ `/'`\]| '' <   | |/ /__\\| |  _   | |   _.____`.  
//      \  /\  / | \__. | | |    | |`\ \  | || \__.,| |,| |__' |  | \____) | 
//       \/  \/   '.__.' [___]  [__|  \_][___]'.__.'\__/`.____.'   \______.' 
//                                                        
-->

<!--
  https://googlechromelabs.github.io/web-audio-samples/audio-worklet/
  https://atornblad.se/generating-sound-in-modern-web-audio-api
-->
  
<script>

var CONF_version="1.0.0";
var CONF_builddate="20240802-130000";

//  ██████  ██    ██ ███████ ███████ ███████ ██████  
//  ██   ██ ██    ██ ██      ██      ██      ██   ██ 
//  ██████  ██    ██ █████   █████   █████   ██████  
//  ██   ██ ██    ██ ██      ██      ██      ██   ██ 
//  ██████   ██████  ██      ██      ███████ ██   ██ 

var _o =
{      
     "EMU_Updates_s"    :10              // Emulator intervals per second  (100ms)
    ,"EMU_AWblockL"     :128            // Length of 1 AudioWorklet data block.  Currently, audio data blocks are always 128 frames long = 128 32-bit floating-point samples for each channel
    ,"EMU_AWblockN"     :34             // Number of AudioWorklet data blocks in buffer
    ,"EMU_SampleRate"   :43520          // Speaker Emulation Sample rate (must be an integer factor of CPU_ClocksTicks_s)          
    //,"CPU_ClocksTicks_s":1023000        // CPU clocksTicks per second
    ,"CPU_ClocksTicks_s":1000000        // CPU clocksTicks per second
};

// Create the audio context
const oLap = new b_time_keeper();
var b_audio,b_player;
var bDebug = true;
var b_worklet_js = "data:text/javascript;base64,"
+"Y2xhc3MgUGxheWVyV29ya2xldCBleHRlbmRzIEF1ZGlvV29ya2xldFByb2Nlc3Nvcntjb25zdHJ1"
+"Y3Rvcigpe3N1cGVyKCksdGhpcy5wb3J0Lm9ubWVzc2FnZT10aGlzLm9ubWVzc2FnZS5iaW5kKHRo"
+"aXMpLHRoaXMuc2FtcGxlRGF0YT1bXSx0aGlzLnNhbXBsZUluZGV4PTB9b25tZXNzYWdlKGUpeyJh"
+"cHBlbmQiPT09ZS5kYXRhLnR5cGUmJih0aGlzLnNhbXBsZURhdGE9ZS5kYXRhLmF1ZGlvLmNvbmNh"
+"dCh0aGlzLnNhbXBsZURhdGEpLHRoaXMuc2FtcGxlSW5kZXgrPWUuZGF0YS5hdWRpby5sZW5ndGgt"
+"MSl9bmV4dE91dHB1dCgpe2xldCBlPXRoaXMuc2FtcGxlRGF0YVt0aGlzLnNhbXBsZUluZGV4XTty"
+"ZXR1cm4gdGhpcy5zYW1wbGVJbmRleD4wPyh0aGlzLnNhbXBsZUluZGV4LS0sMD09dGhpcy5zYW1w"
+"bGVJbmRleCYmKHRoaXMuc2FtcGxlRGF0YT1bXSx0aGlzLnBvcnQucG9zdE1lc3NhZ2Uoe21lc3Nh"
+"Z2U6ImVtcHR5In0pKSxlKTowfXByb2Nlc3MoZSx0KXtsZXQgcz10WzBdLGE9c1swXTtmb3IobGV0"
+"IGw9MDtsPGEubGVuZ3RoOysrbCl7bGV0IHA9dGhpcy5uZXh0T3V0cHV0KCk7YVtsXT1wfXJldHVy"
+"biEwfX1yZWdpc3RlclByb2Nlc3NvcigicGxheWVyLXdvcmtsZXQiLFBsYXllcldvcmtsZXQpOw=="
//var b_worklet_src = "player-worklet.js";  // generates CORS error in Chrome & Firefox

async function b_init(callback)
{
  b_audio = new AudioContext({ latencyHint: 'interactive', sampleRate: _o.EMU_SampleRate });
  await b_audio.audioWorklet.addModule(b_worklet_js);           // Load an audio worklet
  b_player = new AudioWorkletNode(b_audio,'player-worklet');    // Create a player
  b_player.connect(b_audio.destination);                        // Connect the player to the audio context 
  if(callback) callback();
}

function b_trigger(args)
{
  var bInit = (args && _o.EMU_SampleRate != args.samplerate)    // init at sample rate change
            || b_audio===undefined                    // init when audio context is absent
            && (b_audio && b_audio.state != "running"); // don't init when running
  if(bDebug) document.getElementById("dump").innerHTML += "<br>trigger"+(bInit?" - init":"");

  if(args)
  {  
    _o.EMU_AWblockN = args.blocks;
    _o.EMU_SampleRate = args.samplerate;
  }

  if(bInit) b_init(b_play); else b_play();
}

function b_play()
{
  var audio_data = b_calc_wave( _o.EMU_AWblockN * _o.EMU_AWblockL, 4 );
  b_player.port.postMessage({ type:'append', audio: audio_data });    // append data to audio buffer
  if(b_audio.state!="running") { oLap.chrono(true); b_audio.resume() };

  b_player.port.onmessage = (e) => 
  {
    if(e.data.message=="empty")
    {
      var lap = oLap.chrono(false);
      if(bDebug) document.getElementById("dump").innerHTML += "<br>"+lap+"ms";
      b_audio.suspend();
    }
  }
}

function b_calc_wave(len,fac)
{
  var audio_data = new Array(len);
  for(var i=len-1;i>=0;i--)
  {
    var phase = ((i*fac)%128)/128;
    audio_data[i] = Math.sin(phase*Math.PI*2);
  }
  return audio_data;
}

function b_time_keeper()
{
    this.start = 0;
    this.chrono = function(bStart)
    {
    if(bStart==true && this.start==0)
    {
      this.start = performance.now();
      return null;
    }
    else 
    {
      var lap = performance.now() - this.start;
      this.start = 0;
      return Math.round(lap)+" ";
    }      
  }
}

function b_html()
{
  var s = "<style>"
  +"table { float:left; margin:10px; border-collapse: collapse; border: 1px solid black; font-family:'Arial' }\n"
  +"table td { border: 1px solid black; }\n"
  +"</style>"
  +"<table><tr valign=top><td>#Blocks<small><br>"+_o.EMU_AWblockL+" samp./block<br>"+_o.EMU_Updates_s+" intervals/sec<small></td>"
  +"<td>Samplerate<br><small>samp./sec</small></td>"
  +"<td>Duration<small><br>ms</small></td>"
  +"<td>CPU cycles<small><br>per Tick</small></td>"
  +"</tr>"

  var mindev = [1,false];
  for(var i=12800;i<55000;i+=_o.EMU_AWblockL*_o.EMU_Updates_s)
  {
    var val = i / _o.EMU_Updates_s / _o.EMU_AWblockL;
    var ticks = _o.CPU_ClocksTicks_s / i;
    var dev = ((ticks%1)>0.5?(1-(ticks%1)):(ticks%1));
    mindev[1] = false;
    if(dev<mindev[0])
    {
      mindev[0] = dev;
      mindev[1] = true;
    }
    s+= "<tr>"
      +"<td>"+val+"<small> * "+_o.EMU_AWblockL+" * "+_o.EMU_Updates_s+"</small></td>"
      +"<td>"+i+"</td>"
      +"<td>"+(1000/_o.EMU_Updates_s)+"</td>"
      +"<td "+(mindev[1]?"style='background-color:#FF0000'":"")+">"
      +"<small>"+(Math.round(ticks*1000)/1000)+" "+(Math.round(dev*1000)/1000)+"</small>"
      //+"<small>"+(Math.round(ticks)*)+"</small>"
      +"</td>"
      +"<td><button onclick=b_trigger({blocks:"+val+",samplerate:"+i+"})>PLAY</button></td>"
      +"</tr>"
  }
  s += "</table>"
  
  document.getElementById("table").innerHTML = s;
}
</script>


<script>
//  ███████ ███████  ██████  ███████ ███    ██  ██████ ███████ ██████  
//  ██      ██      ██    ██ ██      ████   ██ ██      ██      ██   ██ 
//  ███████ █████   ██    ██ █████   ██ ██  ██ ██      █████   ██████  
//       ██ ██      ██ ▄▄ ██ ██      ██  ██ ██ ██      ██      ██   ██ 
//  ███████ ███████  ██████  ███████ ██   ████  ██████ ███████ ██   ██ 
//                      ▀▀                                             

var s_worklet_js = "data:text/javascript;base64,"
    +"Y2xhc3MgRW11bGF0b3JXb3JrbGV0IGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yCnsKICAg"
    +"IGNvbnN0cnVjdG9yKCkKICAgIHsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMucG9ydC5v"
    +"bm1lc3NhZ2UgPSB0aGlzLm9ubWVzc2FnZS5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuc0QgID0g"
    +"W107CiAgICAgICAgdGhpcy5zSSA9IDA7CiAgICB9CgogICAgb25tZXNzYWdlKGUpCiAgICB7CiAg"
    +"ICAgICAgc3dpdGNoKGUuZGF0YS50eXBlKQogICAgICAgIHsKICAgICAgICAgICAgY2FzZSAibG9h"
    +"ZCI6CiAgICAgICAgICAgICAgICB0aGlzLnNEICA9IGUuZGF0YS5hdWRpbzsKICAgICAgICAgICAg"
    +"ICAgIHRoaXMuc0kgPSB0aGlzLnNELmxlbmd0aCAtIDE7CiAgICAgICAgICAgIGJyZWFrOwogICAg"
    +"ICAgIH0KICAgIH0KCiAgICBuZXh0b3V0KCkKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5zRFsg"
    +"dGhpcy5zST09MD8wOnRoaXMuc0ktLSBdCiAgICB9CgogICAgcHJvY2VzcyhpbnB1dHMsIG91dHMp"
    +"CiAgICB7CiAgICAgICAgY29uc3Qgb3V0ID0gb3V0c1swXTsKICAgICAgICBjb25zdCBjaCA9IG91"
    +"dFswXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoLmxlbmd0aDsgKytpKQogICAgICAg"
    +"ICAgICBjaFtpXSA9IHRoaXMubmV4dG91dCgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQp9"
    +"CgpyZWdpc3RlclByb2Nlc3NvcignZW11bGF0b3Itd29ya2xldCcsIEVtdWxhdG9yV29ya2xldCk7"
//var js = "../res/audioWorklet.js"  // generates CORS ERROR in Chrome & Firefox!

var s_audio,s_player,s_data = new Array(20*128).fill(0);
for(var i=0;i<s_data.length;i++) s_data[i] = Math.sin(i/10)*0.1;

async function s_init(action) 
{
    switch(action)
    {
        case "audio_ctx":
            if(s_audio===undefined)
            {
                s_audio = new AudioContext({ latencyHint: 'interactive', sampleRate: 21760 },"apple_speaker");
                await s_audio.audioWorklet.addModule(s_worklet_js);       // Load an s_audio worklet
            } else s_audio.resume();
        break;
        case "audio_worklet":
            s_player = new AudioWorkletNode(s_audio,'emulator-worklet');    // Create a s_player
            s_player.connect(s_audio.destination); 
        break;
        case "off":
            s_player.disconnect();
            s_audio.suspend();
        break;
    }
}

function s_beep()
{
    if(typeof(s_player)!="undefined" && typeof(s_audio)!="undefined" && s_audio.state!="suspended")
        s_player.port.postMessage({ type:'load', audio: s_data });
}
</script>


<!doctype html>
<html style="background-color:#B0B0B0">
<head>
    <title>Audio Worklet</title>
    <meta name="description" content="Apple II Speaker emulator">
    <meta name="author" content="Freddy Vandriessche">
    <meta charset="utf-8">
    <link rel="stylesheet" href="../res/COM_MAIN.css">
    <script type="text/javascript" src="TOOLS_Header.js"></script>
</head>
<body class="slider_main" onload="b_html();document.getElementById('slider_title').outerHTML = _TITLE();">

  <div id="slider_title"></div>
  <div class="slider_overlay">

      <div id="topmenu">
          <ul id="minitabs" style="font-family:Courier">
              <li>
                <a href="https://atornblad.se/generating-sound-in-modern-web-audio-api" target="_blank">article</a>
              </li>        
          </ul>
      </div>

      <div id=main style="width:100%;height:100%;background: linear-gradient(180deg, rgba(220,220,220,1) 0%, rgba(251,251,251,1) 50%);">
        
        <table>
        <tr><td colspan="2"><big>LIFO BUFFER WORKLET</big></td></tr>
        <tr>
            <td><img style="margin-left:100px;margin-right:100px;width:200px;float:left;image-rendering:pixelated;" src="../res/AudioWorklet_icon.png"></td>
            <td rowspan="2" valign="top" id="dump"></td>
        </tr>
        <tr>
            <td>
                <div id="table" style="font-size:x-small;width:396px;height:220px;float:left;overflow-x:hidden;overflow-y:auto;">
                </div>
            </td>
        </tr>
        </table>

        <!--  -----------------------------------------------------------------------  -->
        
        <table>
          <tr><td colspan="2"><big>SAMPLE SEQUENCER WORKLET</big></td></tr>
          <tr>
            <td>

              SOUND: <button onclick="var b=this.innerHTML=='OFF';this.innerHTML=b?'ON':'OFF';if(b)s_init('audio_ctx').then(()=>s_init('audio_worklet')); else s_init('off').then(()=>{})">OFF</button>
              <button onclick="s_beep()">beep</button>

            </td>
          </tr>
        </table>
      </div>
  </div>    
</body>
</html>