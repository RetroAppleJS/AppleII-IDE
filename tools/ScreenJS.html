<!--
//
// Copyright (c) 2024 Freddy Vandriessche.
// notice: https://raw.githubusercontent.com/RetroAppleJS/AppleII-IDE/main/LICENSE.md
//
//    ______                                            _____   ______   
//  .' ____ \                                          |_   _|.' ____ \  
//  | (___ \_| .---.  _ .--.  .---.  .---.  _ .--.       | |  | (___ \_| 
//   _.____`. / /'`\][ `/'`\]/ /__\\/ /__\\[ `.-. |  _   | |   _.____`.  
//  | \____) || \__.  | |    | \__.,| \__., | | | | | |__' |  | \____) | 
//   \______.''.___.'[___]    '.__.' '.__.'[___||__]`.____.'   \______.'                                       
-->


<html style="background-color:#B0B0B0"><head>
  <title>APPLE SCREEN EMULATOR</title>
  <meta name="description" content="">
  <meta name="author" content="Freddy Vandriessche">
  <meta charset="utf-8">
  <style>
  html {height:100%;font-family:"Arial"}
  body {background-color:#808080;height:100%;margin:0px;padding:0px}

  .no_margins { margin:0px 0px 0px; padding:0px 0px 0px 0px 0px; border:0px solid; }
    </style>
</head>

<script type="text/javascript" src="TOOLS_Header.js"></script>
<script type="text/javascript" src="../res/COM_CONFIG.js"></script>
<script type="text/javascript" src="../res/COM_MAIN.js"></script>

<script>
oCOM.addToEventStack("onload",EMU_init); // EMULATOR KICKSTART


const patterns = 
{
0:{"idx":0,"col":"#000000","sat":0,"cmp":["#000000"],"pat":[0b00,0,0b00,0],"cri":{},"bits":2},
1:{"idx":1,"col":"#7B007B","sat":122,"cmp":["#FF00FF","#000000"],"pat":[0b10,0,0b00,0],"cri":{}},
2:{"idx":2,"col":"#3E7B3E","sat":61,"cmp":["#80FF80","#000000"],"pat":[0b01,0,0b00,0],"cri":{}},
3:{"idx":3,"col":"#7B7B7B","sat":0,"cmp":["#FFFFFF","#000000"],"pat":[0b11,0,0b00,0],"cri":{}},
5:{"idx":4,"col":"#F600F6","sat":122,"cmp":["#FF00FF"],"pat":[0b10,0,0b10,0],"cri":{}},
6:{"idx":5,"col":"#B97BB9","sat":31,"cmp":["#80FF80","#FF00FF"],"pat":[0b01,0,0b10,0],"cri":{}},
7:{"idx":6,"col":"#F67BF6","sat":49,"cmp":["#FFFFFF","#FF00FF"],"pat":[0b11,0,0b10,0],"cri":{}},
10:{"idx":7,"col":"#7BF67B","sat":61,"cmp":["#80FF80"],"pat":[0b01,0,0b01,0],"cri":{}},
11:{"idx":8,"col":"#B9F6B9","sat":24,"cmp":["#FFFFFF","#80FF80"],"pat":[0b11,0,0b01,0],"cri":{}},
15:{"idx":9,"col":"#F6F6F6","sat":0,"cmp":["#FFFFFF"],"pat":[0b11,0,0b11,0],"cri":{}},
16:{"idx":10,"col":"#000000","sat":0,"cmp":["#000000"],"pat":[0b00,128,0b00,0],"cri":{"DOUBL":0}},
17:{"idx":11,"col":"#003E7B","sat":140,"cmp":["#0080FF","#000000"],"pat":[0b10,128,0b00,0],"cri":{}},
18:{"idx":12,"col":"#7B3E00","sat":140,"cmp":["#FF8000","#000000"],"pat":[0b01,128,0b00,0],"cri":{}},
21:{"idx":13,"col":"#7B3EF6","sat":92,"cmp":["#0080FF","#FF00FF"],"pat":[0b10,128,0b10,0],"cri":{}},
22:{"idx":14,"col":"#F63E7B","sat":92,"cmp":["#FF8000","#FF00FF"],"pat":[0b01,128,0b10,0],"cri":{}},
25:{"idx":15,"col":"#3EB9B9","sat":70,"cmp":["#0080FF","#80FF80"],"pat":[0b10,128,0b01,0],"cri":{}},
26:{"idx":16,"col":"#B9B93E","sat":70,"cmp":["#FF8000","#80FF80"],"pat":[0b01,128,0b01,0],"cri":{}},
29:{"idx":17,"col":"#7BB9F6","sat":47,"cmp":["#0080FF","#FFFFFF"],"pat":[0b10,128,0b11,0],"cri":{}},
30:{"idx":18,"col":"#F6B97B","sat":47,"cmp":["#FF8000","#FFFFFF"],"pat":[0b01,128,0b11,0],"cri":{}},
32:{"idx":19,"col":"#000000","sat":0,"cmp":["#000000"],"pat":[0b00,128,0b00,128],"cri":{"DOUBL":0}},
37:{"idx":20,"col":"#007BF6","sat":141,"cmp":["#0080FF"],"pat":[0b10,128,0b10,128],"cri":{}},
42:{"idx":21,"col":"#F67B00","sat":141,"cmp":["#FF8000"],"pat":[0b01,128,0b01,128],"cri":{}}
}




// global data initializations
const _o = {
         "sys":{}     
        ,"EMU_Updates_s":10                 // Emulator intervals per second 
        ,"EMU_DashboardRefresh_s":2         // Dashboard updates per second      
        ,"CPU_ClocksTicks_s":1000000        // CPU clocksTicks per second
    };

var oEMU = { "system":{}, "component":{"CPU":{},"Video":{},"RAM":{},"ROM":{},"IO":{}},"stats":{} }

_o.EMU_IntervalTime_ms = 1000/_o.EMU_Updates_s                  // Emulator Intervals per milisecond
_o.CPU_ClockTicks = _o.CPU_ClocksTicks_s / _o.EMU_Updates_s     // CPU clockTicks per Cycle
oEMU.stats.EMU_DashboardRefresh_cy = Math.round(_o.EMU_Updates_s / _o.EMU_DashboardRefresh_s) // Dashboard refreshes per Cycle
oEMU.component.CPU["dutycycle_time"] = 0;
oEMU.component.CPU["dutycycle_idx"] = 0;

console.log("CPU clock : "+_o.CPU_ClockTicks+" ticks in "+_o.EMU_IntervalTime_ms/1000+" s = "+(1000*_o.CPU_ClockTicks/_o.EMU_IntervalTime_ms)+" ticks/s")
//oCOM = new COM();

function EMU_init()
{
  document.getElementById('slider_title').outerHTML = _TITLE();
  vidContext          = document.getElementById('applescreen').getContext("2d");
  apple2plus          = new Apple2Plus(vidContext);
  appleIntervalHandle = window.setInterval(apple2plus.cycle,_o.EMU_IntervalTime_ms,_o.CPU_ClockTicks);


}



// Monochrome colors (index 0 = full color)
var monoChromes = ["","#FFFFFF","#A0FFF0","#FCE7A1"];

// Lores color to RGB table. (* Hires)
var loresCols = [
["#000000","#000000","#000000","#000000","Black"]  // *
,["#901740","#4D4D4D","#304D48","#4C4631","Magenta"] 
,["#402CA5","#5B5B5B","#395B56","#5A5239","Dark Blue"] 
,["#D043E5","#A8A8A8","#69A89E","#A6986A","Purple"]  // *
,["#006940","#383838","#233835","#383324","Dark Green"] 
,["#808080","#808080","#508078","#7E7451","Grey 1"] 
,["#2F95E5","#8E8E8E","#598E85","#8C8059","Medium Blue"]  // *
,["#BFABFF","#CECECE","#81CEC2","#CBBA82","Light Blue"] 
,["#405400","#313131","#1F312E","#312D1F","Brown"] 
,["#D06A1A","#717171","#47716B","#706748","Orange"]  // *
,["#808080","#808080","#508078","#7E7451","Grey 2"] 
,["#FF96BF","#C7C7C7","#7DC7BB","#C4B47D","Pink"] 
,["#2FBC1A","#575757","#375752","#564F37","Light Green"]  // *
,["#BFD35A","#A4A4A4","#67A49A","#A29568","Yellow"] 
,["#6FE8BF","#B2B2B2","#70B2A8","#B0A170","Aquamarine"] 
,["#FFFFFF","#FFFFFF","#A0FFF0","#FCE7A1","White"]  // *
];


</script>

<script type="text/javascript" src="../res/EMU_apple2video.js"></script>
<script type="text/javascript" src="../res/EMU_apple2hw.js"></script>
<script type="text/javascript" src="../res/EMU_apple2io.js"></script>
<script>

var CONF_version="0.0.1";
var CONF_builddate="20240309-230000"; 

var bDebug = false;
var _D = 
{
     "YVERTL":"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"+"0000000000000000"+"8080808080808080"
              +"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"+"2828282828282828"+"A8A8A8A8A8A8A8A8"
              +"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"+"5050505050505050"+"D0D0D0D0D0D0D0D0"
    ,"YVERTH":"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
              +"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
              +"2024282C3034383C"+"2024282C3034383C"+"2125292D3135393D"+"2125292D3135393D"+"22262A2E32363A3E"+"22262A2E32363A3E"+"23272B2F33373B3F"+"23272B2F33373B3F"
}
var yref = new Uint16Array(_D.YVERTL.length>>1);
for(var i=0;i<_D.YVERTL.length;i+=2) yref[i>>1] = parseInt( _D.YVERTH.substring(i,i+2),16)*256+parseInt( _D.YVERTL.substring(i,i+2),16);

var vidContext, apple2plus;


function Apple2Plus(context)
{
  this.video = new Apple2Video(context);
  this.hw    = new Apple2Hw(this.video);
  // Switch on Apple II Hi-Res graphics
  this.video.reset();
  this.video.setGfx(true);
  this.video.setHires(true);
  this.video.redraw();
}

function wipe_HGR(byte)
{
    // find address and bit location
    //var adr = yref[y] + Math.floor(x/7);              // find address 
    //var wbyt = apple2plus.hw.read(adr) | 1 << x%7;    // OR current bit with pixel bit
    for(var adr=0x2000;adr<0x4000;adr++)
      apple2plus.hw.write(adr,byte);                    // write byte 
}
</script>

<body class="slider_main">

<div id="slider_title"></div>
 <div class="slider_overlay">
    <div id="topmenu">
      <ul id="minitabs">

        <li>
          <BUTTON onclick="draw(0)">0</BUTTON>
          <BUTTON onclick="draw(1)">1</BUTTON>
          <BUTTON onclick="draw(2)">2</BUTTON>
          <BUTTON onclick="draw(3)">3</BUTTON>
          <BUTTON onclick="draw(4)">4</BUTTON>
          <BUTTON onclick="draw(5)">5</BUTTON>
          <BUTTON onclick="draw(6)">6</BUTTON>
          <BUTTON onclick="draw(7)">7</BUTTON>
        </li>
      </ul>
    </div>
    <div id=main>


<!-- -->


<canvas class="appvid" id="applescreen" width="560" height="384"></canvas>



<!-- Code to handle taking the snapshot and displaying it locally -->
<script language="JavaScript">


var gx = {xmin:0,xmax:279,ymax:0,ymin:191}

function draw(color_pattern)
{
  //for(var i=8192;i<16384;i++)      // clear video RAM
  //  apple2plus.hw.write(i,i%255);

  wipe_HGR(0);

  
  for(var yi=0;yi<192;yi++)
  {
    for(var xi=0;xi<280;xi++)
    {
        //var b = pattern(color_pattern,xi,yi);
        setPixel_HGR(xi,yi,color_pattern);
    }
  }
  
/*
  for(var yi=0;yi<1;yi++)
  {
    for(var xi=0;xi<3;xi++)
    {
        //var b = pattern(color_pattern,xi,yi);
        setPixel_HGR(xi,yi,color_pattern);
    }
  }

*/
}

// Overloading the setPixel function to accomodate patterning
function setPixel_HGR(x,y,patternID)
{
    // find address and bit location
    var adr = yref[y] + Math.floor(x/7);              // find address 
    var rbyt = apple2plus.hw.read(adr)                // OR current bit with pixel bit
    var wbyt = pixel(x,y,patternID,rbyt);
    apple2plus.hw.write(adr,wbyt);                    // write byte 
}

function calculate(idx,j,i)
{
  //x % 2 == x & 1
  //x % 4 == x & 3
  //x % 8 == x & 7

  switch(idx)
  {
    case 0: return  [0,false,0];     // black 1 
    case 1: return  [4,j%2==0,0];    // green 
    case 2: return  [3,j%2==1,0];    // purple
    case 3: return  [15,true,0];     // white 1  
    case 4: return  [0,false,128];   // black 2
    case 5: return  [9,j%2==0,128];  // orange
    case 6: return  [2,j%2==1,128];  // blue
    case 7: return  [15,true,128];   // white2 2
  }
}

function pixel(x,y,patternID,rbyt)
{
  //console.log("PIXEL");
  //console.log(oCOM.getBinMulti(rbyt,8));

  var wbyt = rbyt;
  // | (1 << x%7);                     // OR current bit with pixel bit
  if((rbyt&127)==0 && (rbyt&128)!=this.calculate(patternID,x,y)[2])
    wbyt |= this.calculate(patternID,x,y)[2];    // OR high bit

  wbyt |= this.calculate(patternID,x,y)[1]?(1 << x%7):wbyt;                     // OR current bit with pixel bit

  //else
  //wbyt |= this.calculate(patternID,x,y)[1] ?   : 0;
    //document.getElementById("debug").innerHTML += "CONFLICT "+PRINTByte(rbyt)+" >> "+PRINTByte(wbyt)
  //}  // TODO resolve Hi-Byte conflict !!

  console.log(oCOM.getBinMulti(wbyt,8));
  return wbyt;
  //if(this.calculate(patternID,x,y)[0]) return wbyt;
  //return rbyt;
  }


</script>

  </div>
  </div>

  <div id=debug></div>
</body>
</html>
